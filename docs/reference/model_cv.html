<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="model_cv performs repeated, stratified k-fold cross-validation on a linear mixed-effects model (class: lmerMod or lmerTest) or hierarchical generalized additive model (class: gam) model with a single random grouping factor."><title>Performing cross-validation on linear mixed-effects models and hierarchical generalized additive models — model_cv • hetoolkit</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Performing cross-validation on linear mixed-effects models and hierarchical generalized additive models — model_cv"><meta property="og:description" content="model_cv performs repeated, stratified k-fold cross-validation on a linear mixed-effects model (class: lmerMod or lmerTest) or hierarchical generalized additive model (class: gam) model with a single random grouping factor."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">hetoolkit</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/case_study_1.html">Case Study 1</a>
    <a class="dropdown-item" href="../articles/case_study_2.html">Case Study 2</a>
    <a class="dropdown-item" href="../articles/case_study_3.html">Case Study 3</a>
    <a class="dropdown-item" href="../articles/case_study_4.html">Case Study 4</a>
    <a class="dropdown-item" href="../articles/hetoolkit-vignette.html">hetoolkit-Vignette</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"></ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Performing cross-validation on linear mixed-effects models and hierarchical generalized additive models</h1>
      
      <div class="d-none name"><code>model_cv.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>model_cv performs repeated, stratified k-fold cross-validation on a linear mixed-effects model (class: lmerMod or lmerTest) or hierarchical generalized additive model (class: gam) model with a single random grouping factor.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">model_cv</span><span class="op">(</span><span class="va">model</span>, <span class="va">data</span>, <span class="va">group</span>, k<span class="op">=</span><span class="fl">5</span>, r<span class="op">=</span><span class="fl">1</span>, control<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>model</dt>
<dd><p>Model object for cross-validation. Supported classes are "lmerMod" (from lme4::lmer), "lmerTest" (from lmerTest::lmer) and "gam" (from mgcv::gam)</p></dd>


<dt>data</dt>
<dd><p>Data frame or tibble containing data used for model calibration. None of the variables used in 'model' can contain NAs.</p></dd>


<dt>group</dt>
<dd><p>Name of variable in data used as a random grouping factor in model.</p></dd>


<dt>k</dt>
<dd><p>Number of folds. Default = 5.</p></dd>


<dt>r</dt>
<dd><p>Number of repeats. Default = 1.</p></dd>


<dt>control</dt>
<dd><p>Optional settings to prevent convergence issues with lmer models.
Default = NULL.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p>A list of two elements: (i) the RMSE, and (ii) a data frame or tibble containing the input dataset plus r additional columns containing the cross-validation predicted values (named pred_cv#).</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>k-fold cross validation is a re-sampling procedure than can be used to evaluate a model’s predictive performance for groups in the calibration dataset. If the grouping factor is Site, then the function evaluates the model’s ability to predict the response at sites in the calibration dataset.</p>
<p>The data is randomly split into k folds. One fold is omitted (to form a separate test set), the model is fitted to the data from the remaining folds (the training set), and the re-fitted model is then used to predict the response variable for the test set. This is repeated k times so that a prediction is generated for every observation in the full dataset. If required, the whole process can then be repeated r times to provide a more precise estimate of model performance, albeit at greater computational cost. The overall performance of the model is measured by the root mean square error (RMSE), which quantifies the difference between the observed and predicted values. When r&gt;1, the RMSE is calculated using the predicted values across all repeats. Comparing RMSE values for competing models can be used to guide model selection.</p>
<p>Because lmer and gam models include a random grouping factor (e.g. site), the cross-validation procedure is stratified, to ensure that the observations for each group are split as evenly as possible among the k folds.</p>
<p>There is no hard rule for choosing k, but values of 5 or 10 have been demonstrated empirically to provide a good trade-off between bias and variance in a model’s estimated performance. r takes a default value of 1, but can be increased to yield a more precise estimate of the RMSE.</p>
<p>When refitting the model during cross-validation, all arguments to lmer() and gam() take default values, with the exception of (i) 'REML' (which inherits from the original lmer model object), and (ii) 'control' (which can be set via the 'control' argument for lmer models only).</p>
<p>This function is not recommended for use on more complex models with multiple (crossed or nested) random grouping factors.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/" class="external-link">lme4</a></span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Loading required package: Matrix</span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">mgcv</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Loading required package: nlme</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Attaching package: ‘nlme’</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> The following object is masked from ‘package:lme4’:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>     lmList</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> The following object is masked from ‘package:dplyr’:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>     collapse</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> This is mgcv 1.8-41. For overview type 'help("mgcv-package")'.</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Example 1: Cross-validation on linear mixed-effects model</span></span></span>
<span class="r-in"><span><span class="co"># model1 &lt;- lmer(Reaction ~ Days + (Days | Subject), sleepstudy)</span></span></span>
<span class="r-in"><span><span class="co"># out1 &lt;- model_cv(model = model1, data = sleepstudy, group = "Subject", k = 5, r = 1)</span></span></span>
<span class="r-in"><span><span class="co"># out1[[1]] # RMSE</span></span></span>
<span class="r-in"><span><span class="co"># out1[[2]] # predicted values from cross-validation</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># more precise estimate of RMSE by increasing r</span></span></span>
<span class="r-in"><span><span class="co"># model_cv(model = model1, data = sleepstudy, group = "Subject", k = 5,  r = 10)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># convergence issues, so try different optimizer</span></span></span>
<span class="r-in"><span><span class="co"># my_control = lmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 10000))</span></span></span>
<span class="r-in"><span><span class="co"># model1b &lt;- lmer(Reaction ~ Days + (Days | Subject), sleepstudy, control = my_control)</span></span></span>
<span class="r-in"><span><span class="co"># model_cv(model = model1b, data = sleepstudy, group = "Subject", k = 5, r = 1, control = my_control)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Example 2: Cross-validation on hierarchical generalised additive model</span></span></span>
<span class="r-in"><span><span class="co"># model2 &lt;- gam(Reaction ~ s(Days) + s(Subject, bs = "re") + s(Days, Subject, bs = "re"), data = sleepstudy)</span></span></span>
<span class="r-in"><span><span class="co"># model_cv(model = model2, data = sleepstudy, group = "Subject", k = 10, r = 1)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># compare alternative models</span></span></span>
<span class="r-in"><span><span class="co"># model2b &lt;- gam(Reaction ~ s(Days) + s(Subject, bs = "re"), data = sleepstudy)</span></span></span>
<span class="r-in"><span><span class="co"># model2c &lt;- gam(Reaction ~ s(Subject, bs = "re"), data = sleepstudy)</span></span></span>
<span class="r-in"><span><span class="co"># out2 &lt;- model_cv(model = model2, data = sleepstudy, group = "Subject", k = 10, r = 1)</span></span></span>
<span class="r-in"><span><span class="co"># out2b &lt;- model_cv(model = model2b, data = sleepstudy, group = "Subject", k = 10, r = 1)</span></span></span>
<span class="r-in"><span><span class="co"># out2c &lt;- model_cv(model = model2c, data = sleepstudy, group = "Subject", k = 10, r = 1)</span></span></span>
<span class="r-in"><span><span class="co"># out2[[1]]; out2b[[1]] ;out2c[[1]]</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by APEM-Ltd.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer></div>

  

  

  </body></html>

