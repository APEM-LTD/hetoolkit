<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="hetoolkit">
<title>Vignette • hetoolkit</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Vignette">
<meta property="og:description" content="hetoolkit">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">hetoolkit</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.1.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/A.Vignette.html">Vignette</a>
    <a class="dropdown-item" href="../articles/CaseStudy1.html">Macroinvertebrates in chalk streams</a>
    <a class="dropdown-item" href="../articles/CaseStudy2.html">Macroinvertebrates in upland rivers</a>
    <a class="dropdown-item" href="../articles/CaseStudy3.html">Macrophytes in chalk streams</a>
    <a class="dropdown-item" href="../articles/CaseStudy4.html">Climwin analysis</a>
    <a class="dropdown-item" href="../articles/CaseStudy5.html">Diatoms</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../Resources.html">Resources</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../updates.html">Updates</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../FAQs.html">FAQs</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">



<link href="A.Vignette_files/htmltools-fill-0.5.8/fill.css" rel="stylesheet">
<script src="A.Vignette_files/htmlwidgets-1.6.4/htmlwidgets.js"></script><link href="A.Vignette_files/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="A.Vignette_files/leaflet-1.3.1/leaflet.js"></script><link href="A.Vignette_files/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="A.Vignette_files/proj4-2.6.2/proj4.min.js"></script><script src="A.Vignette_files/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="A.Vignette_files/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="A.Vignette_files/leaflet-binding-2.2.2/leaflet.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Vignette</h1>
                        <h4 data-toc-skip class="author">Environment
Agency / APEM Ltd</h4>
            
      
      
      <div class="d-none name"><code>A.Vignette.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/trinker/pacman" class="external-link">pacman</a></span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"pacman"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html" class="external-link">p_load</a></span><span class="op">(</span><span class="va">insight</span>, <span class="va">RCurl</span>, <span class="va">writexl</span>, <span class="va">htmlTable</span>, <span class="va">devtools</span>, <span class="va">roxygen2</span>, <span class="va">ggnewscale</span>,</span>
<span>    <span class="va">visreg</span>, <span class="va">formatR</span>, <span class="va">reshape</span>, <span class="va">glmmTMB</span>, <span class="va">remotes</span>, <span class="va">merTools</span>, <span class="va">GGally</span>, <span class="va">imputeTS</span>, <span class="va">sf</span>, <span class="va">geojsonio</span>,</span>
<span>    <span class="va">leaflet</span>, <span class="va">plyr</span>, <span class="va">rnrfa</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Conditionally install hetoolkit from github install.packages('remotes')</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://remotes.r-lib.org" class="external-link">remotes</a></span><span class="op">)</span></span>
<span><span class="co"># Conditionally install hetoolkit from github</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="st">"hetoolkit"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/installed.packages.html" class="external-link">installed.packages</a></span><span class="op">(</span><span class="op">)</span> <span class="op">==</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"APEM-LTD/hetoolkit"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">hetoolkit</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <code>hetoolkit</code> package comprises a collection of 21
functions for assembling, processing, visualising and modelling
hydro-ecological data. These are:</p>
<ul>
<li>
<code>import_nrfa</code> for importing flow data from the National
River Flow Archive (NRFA);</li>
<li>
<code>import_hde</code> for importing flow data from the Environment
Agency (EA) Hydrology Data Explorer (HDE);</li>
<li>
<code>import_flowfiles</code> for importing flow data from local
files;</li>
<li>
<code>import_flow</code> for importing flow data from a mix of the
above sources;</li>
<li>
<code>impute_flow</code> for infilling missing records in daily flow
time series for one or more sites (gauging stations) using either an
interpolation or an equipercentile method.</li>
<li>
<code>import_inv</code> for importing macroinvertebrate sampling
data from the EA Ecology and Fish Data Explorer;</li>
<li>
<code>import_env</code> for importing environmental base data from
the EA Ecology and Fish Data Explorer;</li>
<li>
<code>import_rhs</code> for importing River Habitat Survey (RHS)
data from the EA’s Open Data portal;</li>
<li>
<code>predict_indices</code> for calculating expected scores for
macroinvertebrate indices using the RICT model (FBA 2020);</li>
<li>
<code>calc_flowstats</code> and <code>calc_rfrstats</code> for
calculating summary statistics describing historical flow
conditions;</li>
<li>
<code>join_he</code> for joining the above datasets;</li>
<li>
<code>plot_heatmap</code> for visualising and summarising gaps in
time series data;</li>
<li>
<code>plot_hev</code> and <code>shiny_hev</code> for producing time
series plots of biology and flow data;</li>
<li>
<code>plot_sitepca</code> for summarising environmental
characteristics of biological sampling sites;</li>
<li>
<code>plot_rngflows</code> for Visualising the range of flow
conditions experienced historically at a site;</li>
<li>
<code>model_cv</code> and <code>model_logocv</code> for performing
cross-validation on linear mixed-effects models and hierarchical
generalized additive models;</li>
<li>
<code>diag_lmer</code> for generating a variety of diagnostic plots
for a mixed-effects regression (lmer) model; and</li>
<li>
<code>plot_predictions</code> for visualising the time series
predictions from a hydro-ecological model.</li>
</ul>
<p>This vignette illustrates a typical workflow using a selection of 20
macroinvertebrate sampling sites from the Environment Agency’s National
Drought Monitoring Network (NDMN).</p>
<p>Although the package has been developed with macroinvertebrate data
in mind, the functions can be used with any kind of biological sampling
data.</p>
</div>
<div class="section level2">
<h2 id="meta-data-file">Meta-data file<a class="anchor" aria-label="anchor" href="#meta-data-file"></a>
</h2>
<p>To link together disparate datasets requires a look-up table of site
ids. In this example, we load a table with four columns:</p>
<ul>
<li>
<em>biol_site_id</em> = id of biology (in this case
macroinvertebrate) sampling site.</li>
<li>
<em>flow_site_id</em> = id of paired flow gauging station.</li>
<li>
<em>flow_input</em> = vector specifying where to source the flow
data for station (either National River Flow Archive “NRFA”, Hydrology
Data Explorer “HDE”, or local files “FLOWFILES”).</li>
<li>
<em>rhs_survey_id</em> = id of paired River Habitat Survey (RHS)
(survey id, not not site id, in case multiple surveys have been
undertaken at a site).</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load master file</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"master_file"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># make all columns character vectors</span></span>
<span><span class="va">master_file</span><span class="op">$</span><span class="va">biol_site_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">master_file</span><span class="op">$</span><span class="va">biol_site_id</span><span class="op">)</span></span>
<span><span class="va">master_file</span><span class="op">$</span><span class="va">rhs_survey_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">master_file</span><span class="op">$</span><span class="va">rhs_survey_id</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># filter master file for selected sites of interest</span></span>
<span><span class="va">master_data</span> <span class="op">&lt;-</span> <span class="va">master_file</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">biol_site_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"34310"</span>, <span class="st">"34343"</span>, <span class="st">"34352"</span>, <span class="st">"55287"</span>, <span class="st">"55395"</span>, <span class="st">"55417"</span>,</span>
<span>        <span class="st">"55673"</span>, <span class="st">"55824"</span>, <span class="st">"55897"</span>, <span class="st">"56065"</span>, <span class="st">"56226"</span>, <span class="st">"54637"</span>, <span class="st">"54769"</span>, <span class="st">"54801"</span>, <span class="st">"80998"</span>,</span>
<span>        <span class="st">"54827"</span>, <span class="st">"77216"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># view data</span></span>
<span><span class="va">master_data</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 17 × 4</span></span></span>
<span><span class="co">##    biol_site_id flow_site_id flow_input rhs_survey_id</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> 34310        2859TH       HDE        39880        </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> 34343        4790TH       HDE        39881        </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> 34352        5420TH       HDE        39797        </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> 77216        F3105        HDE        39621        </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> 55287        029003       HDE        38660        </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> 55395        029001       HDE        38669        </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> 55417        030017       HDE        38670        </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> 55673        032806       HDE        39205        </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> 55824        031031       HDE        39707        </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> 55897        033044       HDE        39798        </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">11</span> 56065        033051       HDE        39310        </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">12</span> 56226        033022       HDE        39839        </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">13</span> 54637        037005       HDE        39560        </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">14</span> 54769        035004       HDE        38952        </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">15</span> 54801        034003       HDE        39612        </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">16</span> 80998        034206       HDE        39891        </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">17</span> 54827        035002       HDE        39574</span></span></code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get site lists, for use with functions</span></span>
<span><span class="va">biolsites</span> <span class="op">&lt;-</span> <span class="va">master_data</span><span class="op">$</span><span class="va">biol_site_id</span></span>
<span><span class="va">flowsites</span> <span class="op">&lt;-</span> <span class="va">master_data</span><span class="op">$</span><span class="va">flow_site_id</span></span>
<span><span class="va">flowinputs</span> <span class="op">&lt;-</span> <span class="va">master_data</span><span class="op">$</span><span class="va">flow_input</span></span>
<span><span class="va">rhssurveys</span> <span class="op">&lt;-</span> <span class="va">master_data</span><span class="op">$</span><span class="va">rhs_survey_id</span></span></code></pre></div>
<div class="section level3">
<h3 id="standardised-column-names">Standardised Column Names<a class="anchor" aria-label="anchor" href="#standardised-column-names"></a>
</h3>
<p>A number of standardised column names are used throughout the
<code>hetoolkit</code> package, and throughout this vignette and its
associated datasets. These include:</p>
<ul>
<li>
<em>biol_site_id</em> = macroinvertebrate sampling site ids.</li>
<li>
<em>flow_site_id</em> = flow gauging station ids.</li>
<li>
<em>rhs_survey_id</em> = River Habitat Survey (RHS) ids (survey id,
not not site id, in case multiple surveys have been undertaken at a
site).</li>
<li>
<em>flow</em> = flow data, as downloaded using the
<code>import_flow</code> function</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="prepare-biology-env-and-rhs-data">Prepare biology, ENV and RHS data<a class="anchor" aria-label="anchor" href="#prepare-biology-env-and-rhs-data"></a>
</h2>
<div class="section level3">
<h3 id="import-biology-data">Import biology data<a class="anchor" aria-label="anchor" href="#import-biology-data"></a>
</h3>
<p>The <code>import_inv</code> function imports macroinvertebrate
sampling data from the Environment Agency’s Ecology and Fish Data
Explorer. The data can either be downloaded from <a href="https://environment.data.gov.uk/ecology-fish/downloads/INV_OPEN_DATA.zip" class="external-link uri">https://environment.data.gov.uk/ecology-fish/downloads/INV_OPEN_DATA.zip</a>
or read in from a local .csv or .rds file. The data can be optionally
filtered by site ID and sample date.</p>
<p>Below, we use our list <code>biolsites</code> to filter the data from
EDE.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Import biology data from EDE</span></span>
<span><span class="va">biol_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/import_inv.html">import_inv</a></span><span class="op">(</span>source <span class="op">=</span> <span class="st">"parquet"</span>, sites <span class="op">=</span> <span class="va">biolsites</span>, start_date <span class="op">=</span> <span class="st">"2010-01-01"</span>,</span>
<span>    end_date <span class="op">=</span> <span class="st">"2020-12-31"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># view biol_data</span></span>
<span><span class="va">biol_data</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 454 × 58</span></span></span>
<span><span class="co">##    biol_site_id SAMPLE_ID SAMPLE_VERSION REPLICATE_CODE SAMPLE_DATE SAMPLE_TYPE</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>      </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> 56065        605567                 1 <span style="color: #BB0000;">NA</span>             2010-03-16  SP         </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> 56065        611126                 1 <span style="color: #BB0000;">NA</span>             2010-07-28  SP         </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> 56065        614704                 1 <span style="color: #BB0000;">NA</span>             2010-10-12  SP         </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> 56065        621146                 1 <span style="color: #BB0000;">NA</span>             2011-03-29  SP         </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> 56065        625474                 1 <span style="color: #BB0000;">NA</span>             2011-06-14  SP         </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> 56065        627625                 1 <span style="color: #BB0000;">NA</span>             2011-08-06  SP         </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> 56065        630894                 1 <span style="color: #BB0000;">NA</span>             2011-10-12  SP         </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> 56065        633498                 1 <span style="color: #BB0000;">NA</span>             2011-12-09  SP         </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> 56065        634677                 1 <span style="color: #BB0000;">NA</span>             2012-02-08  SP         </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> 56065        635806                 1 <span style="color: #BB0000;">NA</span>             2012-04-12  SP         </span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 444 more rows</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 52 more variables: SAMPLE_TYPE_DESCRIPTION &lt;fct&gt;, SAMPLE_METHOD &lt;fct&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   SAMPLE_METHOD_DESCRIPTION &lt;fct&gt;, SAMPLE_REASON &lt;fct&gt;, ANALYSIS_ID &lt;int&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   DATE_OF_ANALYSIS &lt;date&gt;, ANALYSIS_TYPE &lt;fct&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   ANALYSIS_TYPE_DESCRIPTION &lt;fct&gt;, ANALYSIS_METHOD &lt;fct&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   ANALYSIS_METHOD_DESCRIPTION &lt;fct&gt;, BMWP_N_TAXA &lt;int&gt;, BMWP_TOTAL &lt;int&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   BMWP_ASPT &lt;dbl&gt;, CCI_N_TAXA &lt;int&gt;, CCI_CS_TOTAL &lt;int&gt;, CCI_ASPT &lt;dbl&gt;, …</span></span></span></code></pre>
</div>
<div class="section level3">
<h3 id="optional-join-additional-biology-data">Optional: Join additional biology data<a class="anchor" aria-label="anchor" href="#optional-join-additional-biology-data"></a>
</h3>
<p>If the user has additional biology data in a separate Excel file, it
is possible to append this to the EDE download. The additional data must
have the same column names as the EDE download file.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># bind 2 biology data sets - one from EDE and one local file</span></span>
<span></span>
<span><span class="co"># drop any unwanted variables/columns from the EDE download file</span></span>
<span><span class="va">drops_bio</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SAMPLE_VERSION"</span>, <span class="st">"REPLICATE_CODE"</span>, <span class="st">"SAMPLE_TYPE"</span>, <span class="st">"SAMPLE_METHOD"</span>,</span>
<span>    <span class="st">"ANALYSIS_TYPE"</span>, <span class="st">"ANALYSIS_METHOD"</span>, <span class="st">"IS_THIRD_PARTY_DATA"</span>, <span class="st">"WATERBODY_TYPE"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># drop unwanted variables</span></span>
<span><span class="va">biol_data2</span> <span class="op">&lt;-</span> <span class="va">biol_data</span><span class="op">[</span>, <span class="op">!</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">biol_data</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">drops_bio</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># read in additional biology data in csv format</span></span>
<span><span class="va">biol_data_excel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"Data/biol_data_join.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># format columns</span></span>
<span><span class="va">biol_data_excel</span> <span class="op">&lt;-</span> <span class="va">biol_data_excel</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>biol_site_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">biol_site_id</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># convert to tibble format</span></span>
<span><span class="va">biol_data_excel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="va">biol_data_excel</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># bind datasets</span></span>
<span><span class="va">biol_data_final</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">biol_data2</span>, <span class="va">biol_data_excel</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="import-environmental-data">Import environmental data<a class="anchor" aria-label="anchor" href="#import-environmental-data"></a>
</h3>
<p>The <code>import_env</code> function allows the user to download
environmental base data from the Environment Agency’s Ecology and Fish
Data Explorer.</p>
<p>The function either:</p>
<ul>
<li>downloads environmental data data from <a href="https://environment.data.gov.uk/ecology-fish/downloads/INV_OPEN_DATA.zip" class="external-link uri">https://environment.data.gov.uk/ecology-fish/downloads/INV_OPEN_DATA.zip</a><br>
</li>
<li>
<strong>or</strong> imports it from a local .csv or .rds file</li>
</ul>
<p>Data can be optionally filtered by site ID.</p>
<p>When saving, the name of rds file is hard-wired to:
INV_OPEN_DATA_SITES_ALL.rds.</p>
<p>If saving prior to filtering, the name of the filtered rds file is
hard-wired to: INV_OPEN_DATA_SITE_F.rds.</p>
<p>Below, we use our list <code>biolsites</code> to filter the data from
EDE.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Import biology data from EDE</span></span>
<span><span class="va">env_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/import_env.html">import_env</a></span><span class="op">(</span>sites <span class="op">=</span> <span class="va">biolsites</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># view env_data</span></span>
<span><span class="va">env_data</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 17 × 34</span></span></span>
<span><span class="co">##    AGENCY_AREA    REPORTING_AREA CATCHMENT WATERBODY_TYPE WATERBODY_TYPE_DESCR…¹</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> ANGLIAN - NOR… LINCOLNSHIRE … EAST LIN… WBRV           RIVER: Natural/semi-n…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> ANGLIAN - CEN… EAST ANGLIA -… IVEL      WBRV           RIVER: Natural/semi-n…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> ANGLIAN - EAS… EAST ANGLIA -… WAVENEY … WBRV           RIVER: Natural/semi-n…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> ANGLIAN - CEN… EAST ANGLIA -… CAM (2)   WBRV           RIVER: Natural/semi-n…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> ANGLIAN - EAS… EAST ANGLIA -… BURE      WBRV           RIVER: Natural/semi-n…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> THAMES - NORT… HERTFORDSHIRE… RODING    WBRV           RIVER: Natural/semi-n…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> ANGLIAN - CEN… EAST ANGLIA -… LT OUSE,… WBRV           RIVER: Natural/semi-n…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> NORTH EAST - … YORKSHIRE      HULL      WBRV           RIVER: Natural/semi-n…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> ANGLIAN - EAS… EAST ANGLIA -… DEBEN     WBRV           RIVER: Natural/semi-n…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> ANGLIAN - NOR… LINCOLNSHIRE … UPPER NE… WBRV           RIVER: Natural/semi-n…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">11</span> ANGLIAN - EAS… EAST ANGLIA -… COLNE (A… WBRV           RIVER: Natural/semi-n…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">12</span> ANGLIAN - NOR… LINCOLNSHIRE … EAST LIN… WBRV           RIVER: Natural/semi-n…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">13</span> ANGLIAN - NOR… LINCOLNSHIRE … WELLAND   WBRV           RIVER: Natural/semi-n…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">14</span> THAMES - NORT… HERTFORDSHIRE… MIMRAM    WBRV           RIVER: Natural/semi-n…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">15</span> THAMES - NORT… HERTFORDSHIRE… COLNE (T… WBRV           RIVER: Natural/semi-n…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">16</span> ANGLIAN - NOR… LINCOLNSHIRE … CENTRAL … WBRV           RIVER: Natural/semi-n…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">17</span> ANGLIAN - EAS… EAST ANGLIA -… ALDE AND… WBRV           RIVER: Natural/semi-n…</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ abbreviated name: ¹​WATERBODY_TYPE_DESCRIPTION</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 29 more variables: WATER_BODY &lt;chr&gt;, biol_site_id &lt;chr&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   SITE_VERSION &lt;int&gt;, NGR_PREFIX &lt;chr&gt;, EASTING &lt;chr&gt;, NORTHING &lt;chr&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   NGR_10_FIG &lt;chr&gt;, FULL_EASTING &lt;int&gt;, FULL_NORTHING &lt;int&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   WFD_WATERBODY_ID &lt;chr&gt;, ALTITUDE &lt;dbl&gt;, SLOPE &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   DIST_FROM_SOURCE &lt;dbl&gt;, DISCHARGE &lt;dbl&gt;, WIDTH &lt;dbl&gt;, DEPTH &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   BOULDERS_COBBLES &lt;dbl&gt;, PEBBLES_GRAVEL &lt;dbl&gt;, SAND &lt;dbl&gt;, …</span></span></span></code></pre>
</div>
<div class="section level3">
<h3 id="optional-map-biology-sites">Optional: Map biology sites<a class="anchor" aria-label="anchor" href="#optional-map-biology-sites"></a>
</h3>
<div class="section level4">
<h4 id="get-data">Get data<a class="anchor" aria-label="anchor" href="#get-data"></a>
</h4>
<p>We use the environmental base data that we have downloaded from the
Ecology and Fish Data Explorer using <code>import_env</code>, this gives
us their NGRs. We translate the NGRs to full latitude / longitude
(WGS84) and match this back to the env_data so we have information to
include in the plot.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Convert national grid ref (NGR) to full lat / long from env_data (from import_env function)</span></span>
<span><span class="co">## WGS84 is lat/long. </span></span>
<span><span class="va">temp.eastnorths</span> <span class="op">&lt;-</span> <span class="fu">osg_parse</span><span class="op">(</span><span class="va">env_data</span><span class="op">$</span><span class="va">NGR_10_FIG</span>, coord_system <span class="op">=</span> <span class="st">"WGS84"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## match to back to env data to give details on map</span></span>
<span><span class="va">env_data_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">env_data</span>, <span class="va">temp.eastnorths</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">AGENCY_AREA</span>, <span class="va">WATER_BODY</span>, <span class="va">CATCHMENT</span>, <span class="va">WATERBODY_TYPE</span>, <span class="va">biol_site_id</span>, <span class="va">lat</span>, <span class="va">lon</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"&lt;b&gt;"</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">biol_site_id</span><span class="op">)</span>, <span class="st">"&lt;/b&gt;&lt;br/&gt;"</span>, <span class="va">AGENCY_AREA</span>, <span class="st">"&lt;br/&gt;"</span>, <span class="va">CATCHMENT</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="create-the-map">Create the map<a class="anchor" aria-label="anchor" href="#create-the-map"></a>
</h4>
<p>Finally we use leaflet to plot the and points indicating the sample
sites. The points are labelled with the biology sample site ID, EA area
code and the catchment.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Create map</span></span>
<span><span class="fu">leaflet</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">leaflet</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/leaflet/reference/map-layers.html" class="external-link">addTiles</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">leaflet</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/leaflet/reference/map-layers.html" class="external-link">addMarkers</a></span><span class="op">(</span>lng <span class="op">=</span> <span class="va">env_data_map</span><span class="op">$</span><span class="va">lon</span>, lat <span class="op">=</span> <span class="va">env_data_map</span><span class="op">$</span><span class="va">lat</span>, popup <span class="op">=</span> <span class="va">env_data_map</span><span class="op">$</span><span class="va">label</span>,</span>
<span>            options <span class="op">=</span> <span class="fu">popupOptions</span><span class="op">(</span>closeButton <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="leaflet html-widget html-fill-item" id="htmlwidget-74669089923bfc283447" style="width:100%;height:432.632880098888px;"></div>
<script type="application/json" data-for="htmlwidget-74669089923bfc283447">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addTiles","args":["https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"https://openstreetmap.org/copyright/\">OpenStreetMap<\/a>,  <a href=\"https://opendatacommons.org/licenses/odbl/\">ODbL<\/a>"}]},{"method":"addMarkers","args":[[53.49671970248321,52.03148099513547,52.42188939206756,52.06213241108354,52.81527863137155,51.71353558057393,52.43300137943179,53.98837292145028,52.17623239880314,52.23027127116079,51.89447506841803,53.36516759404408,52.59739975130939,51.80465038044489,51.68008766709252,52.83219743200187,52.17046468282927],[-0.1134019304045102,-0.2664879652115948,1.357111007796826,0.1923802530727083,1.252219302275521,0.2581681226699638,0.8776756854191413,-0.3781587614209393,1.332407765043138,-0.933303279108761,0.8655958935671478,-0.01621929500788111,-0.5465305848859605,-0.1465898224005421,-0.5167390863971899,-0.6246977065272319,1.471762358634],null,null,null,{"maxWidth":300,"minWidth":50,"autoPan":true,"keepInView":false,"closeButton":false,"className":""},["<b>55395<\/b><br/>ANGLIAN - NORTHERN<br/>EAST LINCS","<b>56226<\/b><br/>ANGLIAN - CENTRAL<br/>IVEL","<b>80998<\/b><br/>ANGLIAN - EASTERN<br/>WAVENEY (1)","<b>56065<\/b><br/>ANGLIAN - CENTRAL<br/>CAM (2)","<b>54801<\/b><br/>ANGLIAN - EASTERN<br/>BURE","<b>34352<\/b><br/>THAMES - NORTH EAST<br/>RODING","<b>55897<\/b><br/>ANGLIAN - CENTRAL<br/>LT OUSE, SAPISTON, THET","<b>77216<\/b><br/>NORTH EAST - YORKSHIRE<br/>HULL","<b>54827<\/b><br/>ANGLIAN - EASTERN<br/>DEBEN","<b>55673<\/b><br/>ANGLIAN - NORTHERN<br/>UPPER NENE","<b>54637<\/b><br/>ANGLIAN - EASTERN<br/>COLNE (ANGLIAN)","<b>55287<\/b><br/>ANGLIAN - NORTHERN<br/>EAST LINCS","<b>55824<\/b><br/>ANGLIAN - NORTHERN<br/>WELLAND","<b>34343<\/b><br/>THAMES - NORTH EAST<br/>MIMRAM","<b>34310<\/b><br/>THAMES - NORTH EAST<br/>COLNE (THAMES)","<b>55417<\/b><br/>ANGLIAN - NORTHERN<br/>CENTRAL LINCS","<b>54769<\/b><br/>ANGLIAN - EASTERN<br/>ALDE AND ORE"],null,null,null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]}],"limits":{"lat":[51.68008766709252,53.98837292145028],"lng":[-0.933303279108761,1.471762358634]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div class="section level3">
<h3 id="optional-join-additional-environmental-data">Optional: Join additional environmental data<a class="anchor" aria-label="anchor" href="#optional-join-additional-environmental-data"></a>
</h3>
<p>Any additional environmental data in a separate Excel file can be
appended to the EDE download. The additional data must have the same
column names as the EDE download file.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># # bind 2 env data sets - one from EDE and one local file # drop any unwanted</span></span>
<span><span class="co"># variables/columns from the download file drops_env &lt;- c('AGENCY_AREA',</span></span>
<span><span class="co"># 'REPORTING_AREA', 'CATCHMENT', 'WATERBODY_TYPE',</span></span>
<span><span class="co"># 'WATERBODY_TYPE_DESCRIPTION', 'SITE_VERSION', 'NGR_10_FIG', 'FULL_EASTING',</span></span>
<span><span class="co"># 'FULL_NORTHING', 'BASE_DATA_DATE', 'MIN_SAMPLE_DATE', 'MAX_SAMPLE_DATE',</span></span>
<span><span class="co"># 'COUNT_OF_SAMPLES', 'ECN_SITE', 'INV', 'ECN_SITE_INV') # drop unwanted</span></span>
<span><span class="co"># variables env_data &lt;- env_data[ , !(names(env_data) %in% drops_env)] #</span></span>
<span><span class="co"># read-in environmental data in excel format env_data_excel &lt;-</span></span>
<span><span class="co"># read_excel('data/Env_Additonal_Sites.xlsx') # format columns env_data_excel</span></span>
<span><span class="co"># &lt;- env_data_excel %&gt;% dplyr::mutate( biol_site_id =</span></span>
<span><span class="co"># as.character(biol_site_id), WATER_BODY = as.character(WATER_BODY), NGR_PREFIX</span></span>
<span><span class="co"># = as.character(NGR_PREFIX), EASTING = as.character(EASTING), NORTHING =</span></span>
<span><span class="co"># as.character(NORTHING), WFD_WATERBODY_ID = as.character(WFD_WATERBODY_ID)) #</span></span>
<span><span class="co"># convert to tibble format env_data_excel &lt;- as_tibble(env_data_excel) # join</span></span>
<span><span class="co"># datasets env_data &lt;- rbind(env_data, env_data_excel)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="import-rhs-data">Import RHS data<a class="anchor" aria-label="anchor" href="#import-rhs-data"></a>
</h3>
<p>The <code>import_rhs</code> function allows the user to download
River Habitat Survey (RHS) data from Open Data.</p>
<p>The function either:</p>
<ul>
<li>downloads RHS data from Open Data, <a href="https://environment.data.gov.uk/portalstg/sharing/rest/content/items/b82d3ef3750d49f6917fff02b9341d68/data" class="external-link uri">https://environment.data.gov.uk/portalstg/sharing/rest/content/items/b82d3ef3750d49f6917fff02b9341d68/data</a>
</li>
<li>
<strong>or</strong> imports it from a local xlsx or rds file.</li>
</ul>
<p>Data can be optionally filtered by survey ID.</p>
<p>Downloaded raw data files (in .zip format) will be automatically
removed from the working directory following completed execution of the
function.</p>
<p>Below, we use our list <code>rhssurveys</code> to filter the
downloaded data.</p>
<p>To enable the RHS data to be joined to the biology and flow data at a
later stage, it is necessary to rename the <code>Survey ID</code> column
to <code>rhs_survey_id</code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># import RHS data from Open Data</span></span>
<span><span class="va">rhs_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/import_rhs.html">import_rhs</a></span><span class="op">(</span>surveys <span class="op">=</span> <span class="va">rhssurveys</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># rename Survey.ID as rhs_survey_id</span></span>
<span><span class="va">rhs_data</span> <span class="op">&lt;-</span> <span class="va">rhs_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>rhs_survey_id <span class="op">=</span> <span class="va">Survey.ID</span><span class="op">)</span></span></code></pre></div>
<p>If required, unwanted variables can be dropped from the dataset.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># select Columns to keep</span></span>
<span><span class="va">rhs_keep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rhs_survey_id"</span>, <span class="st">"Hms.Poaching.Sub.Score"</span>, <span class="st">"Hms.Rsctned.Bnk.Bed.Sub.Score"</span>,</span>
<span>    <span class="st">"HMS.Score"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># select columns of interest</span></span>
<span><span class="va">rhs_data</span> <span class="op">&lt;-</span> <span class="va">rhs_data</span><span class="op">[</span>, <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">rhs_data</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">rhs_keep</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># view rhs_data</span></span>
<span><span class="va">rhs_data</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 17 × 4</span></span></span>
<span><span class="co">##    rhs_survey_id HMS.Score Hms.Poaching.Sub.Score Hms.Rsctned.Bnk.Bed.Sub.Score</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>                  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>                         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> 38660              <span style="text-decoration: underline;">1</span>305                      0                            80</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> 38669              <span style="text-decoration: underline;">3</span>175                      0                          <span style="text-decoration: underline;">2</span>000</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> 38670               525                     10                             0</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> 38952              <span style="text-decoration: underline;">3</span>140                      0                          <span style="text-decoration: underline;">2</span>280</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> 39205              <span style="text-decoration: underline;">3</span>420                      0                          <span style="text-decoration: underline;">2</span>520</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> 39310              <span style="text-decoration: underline;">3</span>810                      0                          <span style="text-decoration: underline;">2</span>200</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> 39560               240                      0                             0</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> 39574               780                      0                           760</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> 39612              <span style="text-decoration: underline;">2</span>600                     50                          <span style="text-decoration: underline;">2</span>000</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> 39621               250                      0                             0</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">11</span> 39707              <span style="text-decoration: underline;">3</span>040                      0                          <span style="text-decoration: underline;">2</span>720</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">12</span> 39797              <span style="text-decoration: underline;">3</span>120                      0                          <span style="text-decoration: underline;">2</span>080</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">13</span> 39798              <span style="text-decoration: underline;">3</span>570                      0                          <span style="text-decoration: underline;">2</span>520</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">14</span> 39839              <span style="text-decoration: underline;">2</span>855                      0                          <span style="text-decoration: underline;">2</span>440</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">15</span> 39880              <span style="text-decoration: underline;">1</span>740                      0                           240</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">16</span> 39881              <span style="text-decoration: underline;">1</span>055                     60                             0</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">17</span> 39891              <span style="text-decoration: underline;">3</span>170                     10                          <span style="text-decoration: underline;">2</span>760</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="predict-expected-indices">Predict expected indices<a class="anchor" aria-label="anchor" href="#predict-expected-indices"></a>
</h3>
<p>The <code>predict_indices</code> function mirrors the functionality
of the RICT model available on the MS Azure platform (<a href="https://gallery.azure.ai/Experiment/RICT-package-2" class="external-link uri">https://gallery.azure.ai/Experiment/RICT-package-2</a>).
Specifically, it uses the environmental data downloaded from EDE to
generate expected scores under minimally impacted reference conditions
for 80 indices, plus probabilities for RIVPACS end-groups. No
classification is undertaken.</p>
<p>Data validation, transformation (conversion) and predictions are done
within <code>predict_indices</code> using functionality predefined in
the AquaMetrics RICT package (<a href="https://github.com/aquaMetrics/rict" class="external-link uri">https://github.com/aquaMetrics/rict</a>); specifically, the
‘rict_predict’ function from the aquaMetrics RICT package is
applied.</p>
<p>The <code>predict_indices</code> function can accept environmental
data formatted in either of two formats, specified using the
‘file_format’ argument: * “EDE” - environmental data is formatted as
downloaded from the EA’s Ecology Data Explorer * “RICT” - environmental
data is in the RICT template format.</p>
<p>To run, the following columns containing substrate composition data
must not contain NAs, and must total to 100 for every site:</p>
<ul>
<li>BOULDERS_COBBLES</li>
<li>PEBBLES_GRAVEL</li>
<li>SAND</li>
<li>SILT_CLAY</li>
</ul>
<p>The code below demonstrates how to summarise whether these columns
contain NAs, and how to replace NAs as required. Note, this code will
only run successfully if using data in the “EDE” file format.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># check substrate variables for presence of NAs</span></span>
<span><span class="va">env_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">BOULDERS_COBBLES</span>, <span class="va">PEBBLES_GRAVEL</span>, <span class="va">SAND</span>, <span class="va">SILT_CLAY</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html" class="external-link">summarise_all</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 1 × 4</span></span></span>
<span><span class="co">##   BOULDERS_COBBLES PEBBLES_GRAVEL  SAND SILT_CLAY</span></span>
<span><span class="co">##              <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>                0              0     0         0</span></span></code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># replace NAs, if required</span></span>
<span><span class="va">env_data</span><span class="op">$</span><span class="va">BOULDERS_COBBLES</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">env_data</span><span class="op">$</span><span class="va">BOULDERS_COBBLES</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span></code></pre></div>
<p>Now that the substrate data is complete, the expected scores can be
generated. Here, we opt to calculate all available indices - we can then
filter these down at a later stage.</p>
<p>This is an updated version of the <code>predict_indices</code>
function. The first iteration of the function remains available, using
<code>preict_indices_old</code>.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># run predictions</span></span>
<span><span class="va">predict_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predict_indices.html">predict_indices</a></span><span class="op">(</span>env_data <span class="op">=</span> <span class="va">env_data</span>, file_format <span class="op">=</span> <span class="st">"EDE"</span>, all_indices <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   ROW  SITE YEAR FAIL</span></span>
<span><span class="co">## 1  17 54769 2025  ---</span></span>
<span><span class="co">## 2   3 80998 2025  ---</span></span>
<span><span class="co">##                                                                                WARNING</span></span>
<span><span class="co">## 1  You provided LONGITUDE: 1.4717273941385, max value used to train model: 1.3560119. </span></span>
<span><span class="co">## 2 You provided LONGITUDE: 1.35613296461629, max value used to train model: 1.3560119. </span></span>
<span><span class="co">##   REPLACEMENT</span></span>
<span><span class="co">## 1         ---</span></span>
<span><span class="co">## 2         ---</span></span></code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># view predict_data</span></span>
<span><span class="va">predict_data</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 51 × 156</span></span></span>
<span><span class="co">##    biol_site_id LATITUDE LONGITUDE LOG.ALTITUDE LOG.DISTANCE.FROM.SO…¹ LOG.WIDTH</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>                  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> 55395            53.5    -<span style="color: #BB0000;">0.114</span>        1.18                    1.30     0.477</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> 56226            52.0    -<span style="color: #BB0000;">0.267</span>        1.54                    1.21     0.568</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> 80998            52.4     1.36         1.04                    1.54     0.954</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> 56065            52.1     0.191        1.54                    1.31     0.740</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> 54801            52.8     1.25         1.18                    1.33     0.799</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> 34352            51.7     0.258        1.61                    1.46     0.602</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> 55897            52.4     0.877        1.18                    1.47     0.954</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> 77216            54.0    -<span style="color: #BB0000;">0.379</span>        0.699                   1.17     1.08 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> 54827            52.2     1.33         1                       1.32     0.633</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> 55673            52.2    -<span style="color: #BB0000;">0.934</span>        1.78                    1.50     1.10 </span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 41 more rows</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ abbreviated name: ¹​LOG.DISTANCE.FROM.SOURCE</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 150 more variables: LOG.DEPTH &lt;dbl&gt;, MEAN.SUBSTRATUM &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   DISCHARGE.CATEGORY &lt;dbl&gt;, ALKALINITY &lt;dbl&gt;, LOG.ALKALINITY &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   LOG.SLOPE &lt;dbl&gt;, MEAN.AIR.TEMP &lt;dbl&gt;, AIR.TEMP.RANGE &lt;dbl&gt;, p1 &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   p2 &lt;dbl&gt;, p3 &lt;dbl&gt;, p4 &lt;dbl&gt;, p5 &lt;dbl&gt;, p6 &lt;dbl&gt;, p7 &lt;dbl&gt;, p8 &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   p9 &lt;dbl&gt;, p10 &lt;dbl&gt;, p11 &lt;dbl&gt;, p12 &lt;dbl&gt;, p13 &lt;dbl&gt;, p14 &lt;dbl&gt;, …</span></span></span></code></pre>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># drop unwanted variables</span></span>
<span><span class="va">keeps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"biol_site_id"</span>, <span class="st">"SEASON"</span>, <span class="st">"TL2_WHPT_ASPT_AbW_DistFam"</span>, <span class="st">"TL2_WHPT_NTAXA_AbW_DistFam"</span>,</span>
<span>    <span class="st">"TL3_LIFE_Fam_DistFam"</span>, <span class="st">"TL3_PSI_Fam"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">predict_data</span> <span class="op">&lt;-</span> <span class="va">predict_data</span><span class="op">[</span>, <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">predict_data</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">keeps</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">predict_data</span> <span class="op">&lt;-</span> <span class="va">predict_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>Season <span class="op">=</span> <span class="va">SEASON</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Season <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span><span class="va">Season</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"Spring"</span>, <span class="va">Season</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="st">"Summer"</span>,</span>
<span>        <span class="va">Season</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">~</span> <span class="st">"Autumn"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="join-biology-data-environmental-data-and-expected-indices">Join Biology Data, Environmental Data, and Expected Indices<a class="anchor" aria-label="anchor" href="#join-biology-data-environmental-data-and-expected-indices"></a>
</h3>
<p>Prior to joining the biology data with other datasets, it is
advisable to remove any replicate or duplicate samples collected from a
site within the same year and season.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># remove replicate samples</span></span>
<span><span class="va">biol_data</span> <span class="op">&lt;-</span> <span class="va">biol_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">biol_site_id</span>, <span class="va">Year</span>, <span class="va">Season</span>, .keep_all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>The following code demonstrates how to join the expected biology
metric scores from <code>predict_indices</code> to the observed biology
metric scores, using the common fields <code>biol_site_id</code> and
<code>Season</code>.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># join expected and observed biology metric scores, by biol_site_id and Season</span></span>
<span><span class="va">biol_all</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">biol_data</span>, <span class="va">predict_data</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"biol_site_id"</span>, <span class="st">"Season"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Next the environmental base data are joined using the common field
<code>biol_site_id</code>.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># join ENV data, by biol_site_id</span></span>
<span><span class="va">biol_all</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">biol_all</span>, <span class="va">env_data</span>, by <span class="op">=</span> <span class="st">"biol_site_id"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="calculate-oe-ratios">Calculate O:E ratios<a class="anchor" aria-label="anchor" href="#calculate-oe-ratios"></a>
</h3>
<p>Now that the observed and expected biology metric scores are joined
into a single data frame, O:E (Observed/Expected) ratios can be
calculated.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># O:E calcs</span></span>
<span><span class="va">biol_all</span> <span class="op">&lt;-</span> <span class="va">biol_all</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>WHPT_ASPT_O <span class="op">=</span> <span class="va">WHPT_ASPT</span>, WHPT_ASPT_E <span class="op">=</span> <span class="va">TL2_WHPT_ASPT_AbW_DistFam</span>, WHPT_ASPT_OE <span class="op">=</span> <span class="va">WHPT_ASPT_O</span><span class="op">/</span><span class="va">WHPT_ASPT_E</span>,</span>
<span>        WHPT_NTAXA_O <span class="op">=</span> <span class="va">WHPT_N_TAXA</span>, WHPT_NTAXA_E <span class="op">=</span> <span class="va">TL2_WHPT_NTAXA_AbW_DistFam</span>, WHPT_NTAXA_OE <span class="op">=</span> <span class="va">WHPT_NTAXA_O</span><span class="op">/</span><span class="va">WHPT_NTAXA_E</span>,</span>
<span>        LIFE_F_O <span class="op">=</span> <span class="va">LIFE_FAMILY_INDEX</span>, LIFE_F_E <span class="op">=</span> <span class="va">TL3_LIFE_Fam_DistFam</span>, LIFE_F_OE <span class="op">=</span> <span class="va">LIFE_F_O</span><span class="op">/</span><span class="va">LIFE_F_E</span>,</span>
<span>        PSI_O <span class="op">=</span> <span class="va">PSI_FAMILY_SCORE</span>, PSI_E <span class="op">=</span> <span class="va">TL3_PSI_Fam</span>, PSI_OE <span class="op">=</span> <span class="va">PSI_O</span><span class="op">/</span><span class="va">PSI_E</span>, date <span class="op">=</span> <span class="va">SAMPLE_DATE</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="prepare-flow-data">Prepare flow data<a class="anchor" aria-label="anchor" href="#prepare-flow-data"></a>
</h2>
<div class="section level3">
<h3 id="view-flow-data-source">View Flow Data Source<a class="anchor" aria-label="anchor" href="#view-flow-data-source"></a>
</h3>
<p>The data frame nrfa.hde provides a joined dataset which illustrates
which stations we believe are available on the NRFA, and which stations
are available on Hydrology Data Explorer. The dataset was created in
early April 2021, and may become out of date over time.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># view nrfa.hde</span></span>
<span><span class="va">nrfa.hde</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 1,366 × 20</span></span></span>
<span><span class="co">##    wiski.id open  Flow_Site_Name    on.nrfa on.hde  id_N name_N catchment.area_N</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> 021031   FALSE Till at Etal      TRUE    FALSE  <span style="text-decoration: underline;">21</span>031 Till …            648  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> 021032   FALSE Glen at Kirknewt… TRUE    FALSE  <span style="text-decoration: underline;">21</span>032 Glen …            199. </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> 021038   TRUE  Till at Heaton M… TRUE    FALSE  <span style="text-decoration: underline;">21</span>035 Till …            656. </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> 022001   TRUE  Coquet at Morwick TRUE    TRUE   <span style="text-decoration: underline;">22</span>001 Coque…            570. </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> 022002   FALSE Coquet at Bygate  TRUE    FALSE  <span style="text-decoration: underline;">22</span>002 Coque…             59.5</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> 022003   TRUE  Usway Burn at Sh… TRUE    TRUE   <span style="text-decoration: underline;">22</span>003 Usway…             21.4</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> 022004   FALSE Aln at Hawkhill   TRUE    FALSE  <span style="text-decoration: underline;">22</span>004 Aln a…            205  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> 022006   TRUE  Blyth at Hartfor… TRUE    TRUE   <span style="text-decoration: underline;">22</span>006 Blyth…            269. </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> 022007   TRUE  Wansbeck at Mitf… TRUE    TRUE   <span style="text-decoration: underline;">22</span>007 Wansb…            287. </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> <span style="color: #BB0000;">NA</span>       FALSE Alwin at Clennell TRUE    FALSE  <span style="text-decoration: underline;">22</span>008 Alwin…             27.7</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 1,356 more rows</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 12 more variables: opened_N &lt;chr&gt;, closed_N &lt;chr&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   measuring.authority.id_N &lt;chr&gt;, measuring.authority.station.id_N &lt;chr&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   wiskiID_H &lt;chr&gt;, label_H &lt;chr&gt;, stationReference_H &lt;chr&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   riverName_H &lt;chr&gt;, easting_H &lt;dbl&gt;, northing_H &lt;dbl&gt;, col_H &lt;chr&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   value_H &lt;chr&gt;</span></span></span></code></pre>
</div>
<div class="section level3">
<h3 id="import-flow-data">Import flow data<a class="anchor" aria-label="anchor" href="#import-flow-data"></a>
</h3>
<p><code>import_flow</code> is a high-level function that calls
<code>import_nrfa</code>, <code>import_hde</code> and
<code>import_flowfiles</code> to import data for a user-defined list of
sites.</p>
<p>Below, we use the lists <code>flowsites</code> and
<code>flowinputs</code> to specify sites for import.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flow_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/import_flow.html">import_flow</a></span><span class="op">(</span>sites <span class="op">=</span> <span class="va">flowsites</span>, inputs <span class="op">=</span> <span class="va">flowinputs</span>, start_date <span class="op">=</span> <span class="st">"2010-01-01"</span>,</span>
<span>    end_date <span class="op">=</span> <span class="st">"2019-12-31"</span>, dir <span class="op">=</span> <span class="st">"data/wiski"</span>, skip_num <span class="op">=</span> <span class="fl">21</span>, col_order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,</span>
<span>        <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># view flow_data</span></span>
<span><span class="va">flow_data</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 62,084 × 5</span></span></span>
<span><span class="co">##    input flow_site_id date        flow quality</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> HDE   029001       2010-01-01 0.426 Good   </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> HDE   029001       2010-01-02 0.418 Good   </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> HDE   029001       2010-01-03 0.416 Good   </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> HDE   029001       2010-01-04 0.419 Good   </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> HDE   029001       2010-01-05 0.426 Good   </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> HDE   029001       2010-01-06 0.422 Good   </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> HDE   029001       2010-01-07 0.416 Good   </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> HDE   029001       2010-01-08 0.406 Good   </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> HDE   029001       2010-01-09 0.401 Good   </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> HDE   029001       2010-01-10 0.54  Good   </span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 62,074 more rows</span></span></span></code></pre>
</div>
<div class="section level3">
<h3 id="explore-data-gaps">Explore data gaps<a class="anchor" aria-label="anchor" href="#explore-data-gaps"></a>
</h3>
<p>The <code>plot_heatmap</code> function is designed to visualise and
summarise gaps in time series data.</p>
<p>It plots time series data for multiple sites as a tiled heatmap, and
optionally produces tabular summaries of data completeness by time
period and site. Although designed for application with flow time series
data, it can be applied to any type of numerical data, with or without a
time dimension.</p>
<p>In the following example, <code>plot_heatmap</code> is used to
explore gaps in the time series of mean daily flows, and then to
summarise how complete the data is in each month.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># generate a heatmap of mean daily flows</span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_heatmap.html">plot_heatmap</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">flow_data</span>, x <span class="op">=</span> <span class="st">"date"</span>, y <span class="op">=</span> <span class="st">"flow_site_id"</span>, fill <span class="op">=</span> <span class="st">"flow"</span>,</span>
<span>    dual <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># view heatmap</span></span>
<span><span class="fu">gridExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">grid.arrange</a></span><span class="op">(</span><span class="va">a</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="A.Vignette_files/figure-html/plot%20heatmap-1.png" width="700"></p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># view table of completeness statistics for each site</span></span>
<span><span class="va">a</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 17 × 7</span></span></span>
<span><span class="co">##    y      missing total prop_missing number_of_gaps smallest_gap biggest_gap</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> 029001       0  <span style="text-decoration: underline;">3</span>652     0                    <span style="color: #BB0000;">NA</span>           <span style="color: #BB0000;">NA</span>          <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> 029003       0  <span style="text-decoration: underline;">3</span>652     0                    <span style="color: #BB0000;">NA</span>           <span style="color: #BB0000;">NA</span>          <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> 030017       0  <span style="text-decoration: underline;">3</span>652     0                    <span style="color: #BB0000;">NA</span>           <span style="color: #BB0000;">NA</span>          <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> 031031       4  <span style="text-decoration: underline;">3</span>652     0.001<span style="text-decoration: underline;">10</span>               2            1           3</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> 032806       1  <span style="text-decoration: underline;">3</span>652     0.000<span style="text-decoration: underline;">274</span>              1            1           1</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> 033022       0  <span style="text-decoration: underline;">3</span>652     0                    <span style="color: #BB0000;">NA</span>           <span style="color: #BB0000;">NA</span>          <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> 033044       0  <span style="text-decoration: underline;">3</span>652     0                    <span style="color: #BB0000;">NA</span>           <span style="color: #BB0000;">NA</span>          <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> 033051       0  <span style="text-decoration: underline;">3</span>652     0                    <span style="color: #BB0000;">NA</span>           <span style="color: #BB0000;">NA</span>          <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> 034003       0  <span style="text-decoration: underline;">3</span>652     0                    <span style="color: #BB0000;">NA</span>           <span style="color: #BB0000;">NA</span>          <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> 034206       0  <span style="text-decoration: underline;">3</span>652     0                    <span style="color: #BB0000;">NA</span>           <span style="color: #BB0000;">NA</span>          <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">11</span> 035002       0  <span style="text-decoration: underline;">3</span>652     0                    <span style="color: #BB0000;">NA</span>           <span style="color: #BB0000;">NA</span>          <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">12</span> 035004       0  <span style="text-decoration: underline;">3</span>652     0                    <span style="color: #BB0000;">NA</span>           <span style="color: #BB0000;">NA</span>          <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">13</span> 037005       0  <span style="text-decoration: underline;">3</span>652     0                    <span style="color: #BB0000;">NA</span>           <span style="color: #BB0000;">NA</span>          <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">14</span> 2859TH       0  <span style="text-decoration: underline;">3</span>652     0                    <span style="color: #BB0000;">NA</span>           <span style="color: #BB0000;">NA</span>          <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">15</span> 4790TH       0  <span style="text-decoration: underline;">3</span>652     0                    <span style="color: #BB0000;">NA</span>           <span style="color: #BB0000;">NA</span>          <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">16</span> 5420TH      11  <span style="text-decoration: underline;">3</span>652     0.003<span style="text-decoration: underline;">01</span>               1           11          11</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">17</span> F3105       62  <span style="text-decoration: underline;">3</span>652     0.017<span style="text-decoration: underline;">0</span>                1           62          62</span></span></code></pre>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># uses flow_data, as produced using import_flow()</span></span>
<span><span class="va">flow_data</span><span class="op">$</span><span class="va">month</span> <span class="op">&lt;-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html" class="external-link">month</a></span><span class="op">(</span><span class="va">flow_data</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span>
<span><span class="va">flow_data</span><span class="op">$</span><span class="va">year</span> <span class="op">&lt;-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html" class="external-link">year</a></span><span class="op">(</span><span class="va">flow_data</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span>
<span><span class="va">temp1</span> <span class="op">&lt;-</span> <span class="va">flow_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">month</span>, <span class="va">year</span>, <span class="va">flow_site_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span>.cols <span class="op">=</span> <span class="st">"flow"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">flow</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>        missing <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">flow</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, total <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">flow</span><span class="op">)</span>, perc_missing <span class="op">=</span> <span class="op">~</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">flow</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">flow</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span></span>
<span>            <span class="fl">100</span><span class="op">)</span>, .names <span class="op">=</span> <span class="st">"{.fn}"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">temp1</span><span class="op">$</span><span class="va">yy_mm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">temp1</span><span class="op">$</span><span class="va">year</span>, <span class="va">temp1</span><span class="op">$</span><span class="va">month</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># heatmap of monthly mean flows.</span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_heatmap.html">plot_heatmap</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">temp1</span>, x <span class="op">=</span> <span class="st">"yy_mm"</span>, y <span class="op">=</span> <span class="st">"flow_site_id"</span>, fill <span class="op">=</span> <span class="st">"mean"</span>, dual <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># view heatmap</span></span>
<span><span class="fu">gridExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">grid.arrange</a></span><span class="op">(</span><span class="va">a</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="A.Vignette_files/figure-html/plot%20heatmap-2.png" width="700"></p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># heatmap of monthly percentage completeness of the daily flow data</span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_heatmap.html">plot_heatmap</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">temp1</span>, x <span class="op">=</span> <span class="st">"yy_mm"</span>, y <span class="op">=</span> <span class="st">"flow_site_id"</span>, fill <span class="op">=</span> <span class="st">"perc_missing"</span><span class="op">)</span></span>
<span><span class="co"># view heatmap</span></span>
<span><span class="fu">gridExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">grid.arrange</a></span><span class="op">(</span><span class="va">a</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="A.Vignette_files/figure-html/plot%20heatmap-3.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="impute-flow-gaps">Impute flow gaps<a class="anchor" aria-label="anchor" href="#impute-flow-gaps"></a>
</h3>
<p>The <code>impute_flow</code> function is designed to infill missing
records in daily flow time series for one or more sites (gauging
stations) using either an interpolation or an equipercentile method.
Imputation of missing flow data can improve the later estimation of flow
statistics using the calc_flowstats() function and aid the visualisation
of hydro-ecological relationships using the plot_hev() function.</p>
<p>Note, it is advisable to consult a hydrologist when doing any flow
imputation, particularly if your data contains extensive/lengthy
gaps.</p>
<p>The most straight-forward interpolation can be completed using a
‘linear’ or ‘exponential’ method.</p>
<p>The output dataset is in long format, similar to that produced by
<code>import_flow</code>. The output dataset contains an ‘imputed’
colunm; this is a flag indicating whether each flow value is original
(0) or imputed (1). Additionally, this function plots up observed and
imputed flow values for each site; enabling the user to validate the
imputation.</p>
<p>Flow interpolation using the ‘linear’ method is demonstrated
below:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flow_data_imputed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/impute_flow.html">impute_flow</a></span><span class="op">(</span><span class="va">flow_data</span>, site_col <span class="op">=</span> <span class="st">"flow_site_id"</span>, date_col <span class="op">=</span> <span class="st">"date"</span>,</span>
<span>    flow_col <span class="op">=</span> <span class="st">"flow"</span>, method <span class="op">=</span> <span class="st">"linear"</span><span class="op">)</span></span></code></pre></div>
<p>If applying the ‘equipercentile’ method, an optional ‘donor’ argument
can be specified. The ‘donor’ argument must be specified in data frame
format with at least two columns: the first a list of flow sites
requiring imputation, and the second a list of paired donor sites. The
function assumes that data for all flow sites specified within the
‘donor’ data table, including paired donor sites, are contained within
the ‘flow_data’ supplied.</p>
<p>If flow data for paired donor stations are not already included
within the ‘flow_data’ dataframe, then it will be necessary to import
the donor flow data, and then append these to the existing flow data
(which can be done using the bind_rows() function). For brevity here we
use an existing site for donor data.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create 'donor' data frame for site with relatively large data gap (F3105)</span></span>
<span><span class="va">donor_mapping</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>station <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"F3105"</span><span class="op">)</span>, donor_station <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"029001"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get a list of donor sites</span></span>
<span><span class="va">donorsites</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">donor_mapping</span><span class="op">$</span><span class="va">donor_station</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># impute flow data using the equipercentile method</span></span>
<span><span class="va">flow_data_imputed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/impute_flow.html">impute_flow</a></span><span class="op">(</span><span class="va">flow_data</span>, site_col <span class="op">=</span> <span class="st">"flow_site_id"</span>, date_col <span class="op">=</span> <span class="st">"date"</span>,</span>
<span>    flow_col <span class="op">=</span> <span class="st">"flow"</span>, method <span class="op">=</span> <span class="st">"equipercentile"</span>, donor <span class="op">=</span> <span class="va">donor_mapping</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="calculate-flow-statistics">Calculate flow statistics<a class="anchor" aria-label="anchor" href="#calculate-flow-statistics"></a>
</h3>
<p><code>calc_flowstats</code> takes a time series of measured or
modelled flows and uses a user-defined moving window to calculate a
suite of long-term and time-varying flow statistics flow statistics for
one or more sites (stations).</p>
<p>The function uses the win_start, win_width and win_step arguments to
define a moving window, which divides the flow time series into a
sequence of time periods. These time periods may be contiguous,
non-contiguous or overlapping.</p>
<p>The sequence of time periods continues up to and including the
present date, even when this extends beyond the period covered by the
input flow dataset, as this facilitates the subsequent joining of flow
statistics and ecology data by the <code>join_he</code> function.</p>
<p>It is primarily designed to work with mean daily flows (e.g. as
produced by import_flow), but can also be applied to time series data on
a longer (e.g. monthly) time step.</p>
<p>Regardless, the data should be regularly spaced and the same time
step should be used for all sites.</p>
<p>The function also requires site, date and flow data columns to be
specified in order to run. The default values for these arguments,
“flow_site_id”, “date” and “flow” respectively, match the column headers
from the outputs of the <code>import_flow</code> and
<code>impute_flow</code> functions. The defaults allow the data from
these functions to be passed without editing into
<code>calc_flowstats</code>, however the names can be changed as normal
to match the data supplied.</p>
<p>This is an updated version of the <code>calc_flowstats</code>
function. The first iteration of the function, which employs fixed
6-monthly spring and autumn flow periods, remains available using
<code>calc_flowstats_old</code>.</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># uses flow_data, as produced using import_flow() will also accept interpolated</span></span>
<span><span class="co"># flow data (flow_data_imputed), as produced using impute_flow()</span></span>
<span></span>
<span><span class="co"># set any negative flow readings to NA</span></span>
<span><span class="va">flow_data</span><span class="op">$</span><span class="va">flow</span><span class="op">[</span><span class="va">flow_data</span><span class="op">$</span><span class="va">flow</span> <span class="op">&lt;=</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span></span>
<span><span class="co"># calculate flow statistics</span></span>
<span><span class="va">flow_stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_flowstats.html">calc_flowstats</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">flow_data</span>, site_col <span class="op">=</span> <span class="st">"flow_site_id"</span>, date_col <span class="op">=</span> <span class="st">"date"</span>,</span>
<span>    flow_col <span class="op">=</span> <span class="st">"flow"</span>, win_width <span class="op">=</span> <span class="st">"6 months"</span>, win_step <span class="op">=</span> <span class="st">"6 months"</span><span class="op">)</span></span></code></pre></div>
<p><code>calc_flowstats</code> returns a list of two data frames. The
first contains a suite of time-varying flow statistics for every 6 month
winter/summer period at every site. See <code><a href="../reference/calc_flowstats.html">?calc_flowstats</a></code> for
definitions of these statistics.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># view time-varying flow statistics</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">flow_stats</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   flow_site_id win_no start_date   end_date n_data n_missing n_total</span></span>
<span><span class="co">## 1       029001      1 1995-04-01 1995-09-30      0       183     183</span></span>
<span><span class="co">## 2       029001      2 1995-10-01 1996-03-31      0       183     183</span></span>
<span><span class="co">## 3       029001      3 1996-04-01 1996-09-30      0       183     183</span></span>
<span><span class="co">## 4       029001      4 1996-10-01 1997-03-31      0       182     182</span></span>
<span><span class="co">## 5       029001      5 1997-04-01 1997-09-30      0       183     183</span></span>
<span><span class="co">## 6       029001      6 1997-10-01 1998-03-31      0       182     182</span></span>
<span><span class="co">##   prop_missing mean sd Q5 Q10 Q20 Q25 Q30 Q50 Q70 Q75 Q80 Q90 Q95 Q99 Q5z Q10z</span></span>
<span><span class="co">## 1            1   NA NA NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA   NA</span></span>
<span><span class="co">## 2            1   NA NA NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA   NA</span></span>
<span><span class="co">## 3            1   NA NA NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA   NA</span></span>
<span><span class="co">## 4            1   NA NA NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA   NA</span></span>
<span><span class="co">## 5            1   NA NA NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA   NA</span></span>
<span><span class="co">## 6            1   NA NA NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA   NA</span></span>
<span><span class="co">##   Q20z Q25z Q30z Q50z Q70z Q75z Q80z Q90z Q95z Q99z dry_n dry_e dry_start</span></span>
<span><span class="co">## 1   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA    NA    NA        NA</span></span>
<span><span class="co">## 2   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA    NA    NA        NA</span></span>
<span><span class="co">## 3   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA    NA    NA        NA</span></span>
<span><span class="co">## 4   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA    NA    NA        NA</span></span>
<span><span class="co">## 5   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA    NA    NA        NA</span></span>
<span><span class="co">## 6   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA    NA    NA        NA</span></span>
<span><span class="co">##   dry_end dry_mid low_n low_e low_start low_end low_mid low_magnitude</span></span>
<span><span class="co">## 1      NA      NA    NA    NA        NA      NA      NA            NA</span></span>
<span><span class="co">## 2      NA      NA    NA    NA        NA      NA      NA            NA</span></span>
<span><span class="co">## 3      NA      NA    NA    NA        NA      NA      NA            NA</span></span>
<span><span class="co">## 4      NA      NA    NA    NA        NA      NA      NA            NA</span></span>
<span><span class="co">## 5      NA      NA    NA    NA        NA      NA      NA            NA</span></span>
<span><span class="co">## 6      NA      NA    NA    NA        NA      NA      NA            NA</span></span>
<span><span class="co">##   low_severity high_n high_e high_start high_end high_mid e_above3xq50</span></span>
<span><span class="co">## 1           NA     NA     NA         NA       NA       NA           NA</span></span>
<span><span class="co">## 2           NA     NA     NA         NA       NA       NA           NA</span></span>
<span><span class="co">## 3           NA     NA     NA         NA       NA       NA           NA</span></span>
<span><span class="co">## 4           NA     NA     NA         NA       NA       NA           NA</span></span>
<span><span class="co">## 5           NA     NA     NA         NA       NA       NA           NA</span></span>
<span><span class="co">## 6           NA     NA     NA         NA       NA       NA           NA</span></span>
<span><span class="co">##   e_above5xq50 e_above7xq50 volume vol_z min min_z min_doy min_7day min_7day_z</span></span>
<span><span class="co">## 1           NA           NA     NA    NA  NA    NA      NA       NA         NA</span></span>
<span><span class="co">## 2           NA           NA     NA    NA  NA    NA      NA       NA         NA</span></span>
<span><span class="co">## 3           NA           NA     NA    NA  NA    NA      NA       NA         NA</span></span>
<span><span class="co">## 4           NA           NA     NA    NA  NA    NA      NA       NA         NA</span></span>
<span><span class="co">## 5           NA           NA     NA    NA  NA    NA      NA       NA         NA</span></span>
<span><span class="co">## 6           NA           NA     NA    NA  NA    NA      NA       NA         NA</span></span>
<span><span class="co">##   min_7day_doy min_30day min_30day_z min_30day_doy max max_z max_doy</span></span>
<span><span class="co">## 1           NA        NA          NA            NA  NA    NA      NA</span></span>
<span><span class="co">## 2           NA        NA          NA            NA  NA    NA      NA</span></span>
<span><span class="co">## 3           NA        NA          NA            NA  NA    NA      NA</span></span>
<span><span class="co">## 4           NA        NA          NA            NA  NA    NA      NA</span></span>
<span><span class="co">## 5           NA        NA          NA            NA  NA    NA      NA</span></span>
<span><span class="co">## 6           NA        NA          NA            NA  NA    NA      NA</span></span></code></pre>
<p>The second data table contains long-term flow statistics. The data
are arranged in long format, with the following columns:</p>
<ul>
<li>flow_site_id (a unique site id);</li>
<li>season (S = summer, W = winter, A = all);</li>
<li>parameter (base flow index (bfi), flow duration curve percentiles
(p1 to p99), and seasonal means and standard deviations for Q5, Q10,
Q20, Q25, Q30, Q50, Q70, Q75, Q80, Q90, Q95 and Q99); and</li>
<li>value (calculated statistic).</li>
</ul>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># view long-term flow statistics</span></span>
<span><span class="va">flow_stats</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 2,261 × 5</span></span></span>
<span><span class="co">##    flow_site_id start_date end_date   parameter value</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> 029001       2010-01-01 2019-12-31 max        1.18</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> 029003       2010-01-01 2019-12-31 max        1.58</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> 030017       2010-01-01 2019-12-31 max        1.70</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> 031031       2010-01-01 2019-12-31 max       15.9 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> 032806       2010-01-01 2019-12-31 max        7.83</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> 033022       2010-01-01 2019-12-31 max       11.8 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> 033044       2010-01-01 2019-12-31 max        5.48</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> 033051       2010-01-01 2019-12-31 max        3.46</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> 034003       2010-01-01 2019-12-31 max        3.44</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> 034206       2010-01-01 2019-12-31 max       12.5 </span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 2,251 more rows</span></span></span></code></pre>
</div>
<div class="section level3">
<h3 id="join-biology-and-flow-data">Join biology and flow data<a class="anchor" aria-label="anchor" href="#join-biology-and-flow-data"></a>
</h3>
<p>The <code>join_he</code> function links biology data with
time-varying flow statistics for one or more antecedent (lagged) time
periods (as calculated by the <code>calc_flowstats</code> function) to
create a combined dataset for hydro-ecological modelling.</p>
<p>The function allows to user to select a method for linking biology
samples to flow statistics for antecedent time periods: * using method =
“A” (default), lag 0 is defined for each biology sample as the most
recently finished flow time period; * using method = “B”, lag 0 is
defined as the most recently started flow time period. To describe the
antecedent flow conditions prior to each biology sample, the time
periods are labelled relative to the date of the biology sample, with
lag 0 representing either the most recently finished (method = “A”) or
most recently started (method = “B”) flow time period. The time period
immediately prior to the Lag 0 time period is the Lag 1 period, and the
period immediately prior to that is the Lag 2 period, and so on. The
function allows the user to select which antecedent (lagged) time
periods the biology data is joined to, e.g. lag = c(0,1,2).</p>
<p>The function also includes an option to specify the ‘join_type’: *
“add_flows” (default) produces a dataset of biological metrics (response
variables) and flow statistics (predictor variables) for
hydro-ecological modelling. * “add_biol” produces a time series of flow
statistics with associated biological metrics which can be used to
assess the coverage of historical flow conditions using the
<code>plot_rngflows</code> function.</p>
<p>This is an updated version of the <code>join_he</code> function. The
first iteration of the function remains available, using
<code>join_he_old</code>.</p>
<p>We will join the data for the pairs of biology and flow sites
specified in <code>master_data</code>.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get output from calc_flowstats</span></span>
<span><span class="va">flowstats_1</span> <span class="op">&lt;-</span> <span class="va">flow_stats</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># create two-column table mapping biology sites to flow sites</span></span>
<span><span class="va">mapping</span> <span class="op">&lt;-</span> <span class="va">master_data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"biol_site_id"</span>, <span class="st">"flow_site_id"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># join flow statistics to biology data</span></span>
<span></span>
<span><span class="va">join_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/join_he.html">join_he</a></span><span class="op">(</span>biol_data <span class="op">=</span> <span class="va">biol_all</span>, flow_stats <span class="op">=</span> <span class="va">flowstats_1</span>, mapping <span class="op">=</span> <span class="va">mapping</span>,</span>
<span>    lags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"A"</span>, join_type <span class="op">=</span> <span class="st">"add_flows"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># view join_data</span></span>
<span><span class="va">join_data</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 414 × 242</span></span></span>
<span><span class="co">##    biol_site_id SAMPLE_ID SAMPLE_VERSION REPLICATE_CODE SAMPLE_DATE SAMPLE_TYPE</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>      </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> 56065        605567                 1 <span style="color: #BB0000;">NA</span>             2010-03-16  SP         </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> 56065        611126                 1 <span style="color: #BB0000;">NA</span>             2010-07-28  SP         </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> 56065        614704                 1 <span style="color: #BB0000;">NA</span>             2010-10-12  SP         </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> 56065        621146                 1 <span style="color: #BB0000;">NA</span>             2011-03-29  SP         </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> 56065        625474                 1 <span style="color: #BB0000;">NA</span>             2011-06-14  SP         </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> 56065        630894                 1 <span style="color: #BB0000;">NA</span>             2011-10-12  SP         </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> 56065        633498                 1 <span style="color: #BB0000;">NA</span>             2011-12-09  SP         </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> 56065        634677                 1 <span style="color: #BB0000;">NA</span>             2012-02-08  SP         </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> 56065        635806                 1 <span style="color: #BB0000;">NA</span>             2012-04-12  SP         </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> 56065        638557                 1 <span style="color: #BB0000;">NA</span>             2012-06-27  SP         </span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 404 more rows</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 236 more variables: SAMPLE_TYPE_DESCRIPTION &lt;fct&gt;, SAMPLE_METHOD &lt;fct&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   SAMPLE_METHOD_DESCRIPTION &lt;fct&gt;, SAMPLE_REASON &lt;fct&gt;, ANALYSIS_ID &lt;int&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   DATE_OF_ANALYSIS &lt;date&gt;, ANALYSIS_TYPE &lt;fct&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   ANALYSIS_TYPE_DESCRIPTION &lt;fct&gt;, ANALYSIS_METHOD &lt;fct&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   ANALYSIS_METHOD_DESCRIPTION &lt;fct&gt;, BMWP_N_TAXA &lt;int&gt;, BMWP_TOTAL &lt;int&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   BMWP_ASPT &lt;dbl&gt;, CCI_N_TAXA &lt;int&gt;, CCI_CS_TOTAL &lt;int&gt;, CCI_ASPT &lt;dbl&gt;, …</span></span></span></code></pre>
</div>
<div class="section level3">
<h3 id="join-rhs-data">Join RHS data<a class="anchor" aria-label="anchor" href="#join-rhs-data"></a>
</h3>
<p>If required, the RHS data can also be joined manually to the combined
biology and flow dataset.</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create mapping rhs_survey_id &lt;- as.character(rhssurveys) flow_site_id &lt;-</span></span>
<span><span class="co"># as.character(flowsites) mapping &lt;- data.frame(flow_site_id, rhs_survey_id)</span></span>
<span></span>
<span><span class="co"># create two-column table mapping biology sites to RHS surveys</span></span>
<span><span class="va">mapping</span> <span class="op">&lt;-</span> <span class="va">master_data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"biol_site_id"</span>, <span class="st">"rhs_survey_id"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Join RHS data to join_data</span></span>
<span><span class="va">all_data</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">join_data</span>, <span class="va">mapping</span>, by <span class="op">=</span> <span class="st">"biol_site_id"</span><span class="op">)</span></span>
<span><span class="va">all_data</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">all_data</span>, <span class="va">rhs_data</span>, by <span class="op">=</span> <span class="st">"rhs_survey_id"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="exploratory-data-anlaysis">Exploratory data anlaysis<a class="anchor" aria-label="anchor" href="#exploratory-data-anlaysis"></a>
</h2>
<div class="section level3">
<h3 id="pairwise-correlations">Pairwise correlations<a class="anchor" aria-label="anchor" href="#pairwise-correlations"></a>
</h3>
<p>Plotting pairwise correlations among alternative biological metrics
can be useful when deciding which metric(s) to analysis. In this
example, the <code>ggpairs</code> function from the <code>GGally</code>
package is used to explore the distribution and correlations of four
commonly used macroinvertebrate metrics.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">GGally</span><span class="fu">::</span><span class="fu"><a href="https://ggobi.github.io/ggally/reference/ggpairs.html" class="external-link">ggpairs</a></span><span class="op">(</span><span class="va">all_data</span>, columns<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"LIFE_F_OE"</span>, <span class="st">"WHPT_ASPT_OE"</span>, <span class="st">"WHPT_NTAXA_OE"</span>, <span class="st">"PSI_OE"</span><span class="op">)</span>, </span>
<span>                         upper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>continuous <span class="op">=</span> <span class="fu">GGally</span><span class="fu">::</span><span class="fu"><a href="https://ggobi.github.io/ggally/reference/wrap.html" class="external-link">wrap</a></span><span class="op">(</span><span class="st">"cor"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                         diag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>continuous <span class="op">=</span> <span class="st">"densityDiag"</span><span class="op">)</span>,</span>
<span>                         lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>continuous <span class="op">=</span> <span class="fu">GGally</span><span class="fu">::</span><span class="fu"><a href="https://ggobi.github.io/ggally/reference/wrap.html" class="external-link">wrap</a></span><span class="op">(</span><span class="st">"points"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="A.Vignette_files/figure-html/ggpairs1-1.png" width="700"></p>
<p>Similarly, a <code>ggpairs</code> plot can also be used to visualise
relationships between response and predictor variables, and to identify
co-linearity among predictor variables.</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">GGally</span><span class="fu">::</span><span class="fu"><a href="https://ggobi.github.io/ggally/reference/ggpairs.html" class="external-link">ggpairs</a></span><span class="op">(</span><span class="va">all_data</span>, columns<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"LIFE_F_OE"</span>, <span class="st">"Q95z_lag0"</span>, <span class="st">"Q10z_lag0"</span><span class="op">)</span>, </span>
<span>                         upper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>continuous <span class="op">=</span> <span class="fu">GGally</span><span class="fu">::</span><span class="fu"><a href="https://ggobi.github.io/ggally/reference/wrap.html" class="external-link">wrap</a></span><span class="op">(</span><span class="st">"cor"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                         diag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>continuous <span class="op">=</span> <span class="st">"densityDiag"</span><span class="op">)</span>,</span>
<span>                         lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>continuous <span class="op">=</span> <span class="fu">GGally</span><span class="fu">::</span><span class="fu"><a href="https://ggobi.github.io/ggally/reference/wrap.html" class="external-link">wrap</a></span><span class="op">(</span><span class="st">"points"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="A.Vignette_files/figure-html/ggpairs2-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="assess-site-similarity">Assess site similarity<a class="anchor" aria-label="anchor" href="#assess-site-similarity"></a>
</h3>
<p>Prior to building a hydro-ecological model, it is important identify
any sites that could potentially be outliers because they are
physically, chemically or geographically dissimilar to the others sites
in the dataset. The <code>plot-sitepca</code> function performs a
Principal Components Analysis (PCA) which reduces a set of site-level
environmental variables down to two uncorrelated ‘principal components’
and plots these components as a two-dimensional scatter plot. Sites that
are closer together have more similar environmental characteristics. The
proportion of the total environmental variation explained by each
component is indicated on the axis labels. The environmental gradients
represented by the two axes can be interpreted by reference to the
arrows (eigenvectors), which show the direction and strength of
correlation between the principal components and the individual
environmental variables.</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_sitepca.html">plot_sitepca</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">env_data</span>, vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ALTITUDE"</span>, <span class="st">"SLOPE"</span>, <span class="st">"WIDTH"</span>, <span class="st">"DEPTH"</span>, <span class="st">"BOULDERS_COBBLES"</span>, <span class="st">"PEBBLES_GRAVEL"</span>, <span class="st">"SILT_CLAY"</span><span class="op">)</span>, eigenvectors <span class="op">=</span> <span class="cn">TRUE</span>, label_by <span class="op">=</span> <span class="st">"biol_site_id"</span><span class="op">)</span></span></code></pre></div>
<p><img src="A.Vignette_files/figure-html/sitepca-1.png" width="700"></p>
<p>In this example, the first component (x-axis) can be interpreted as a
longitudinal gradient from wider, deeper rivers (left) to smaller,
steeper streams (right), and the second component (y-axis) can be
interpreted a gradient in substrate composition from finer
pebbles/gravels (top) to coarser boulder/cobbles (bottom). On the basis
of these results, we may wish to consider whether sites such as 77216
and 55824 are suitable for inclusion in the model, or whether they are
sufficiently different to warrant being excluded.</p>
</div>
<div class="section level3">
<h3 id="assess-coverage-of-historical-flow-conditions">Assess coverage of historical flow conditions<a class="anchor" aria-label="anchor" href="#assess-coverage-of-historical-flow-conditions"></a>
</h3>
<p>A hydro-ecological model has a greater chance of revealing
relationships between biology metrics and flow variables if the biology
samples span a wide range of flow conditions. Good coverage of
historical flow conditions by the biology sample data also means that
the calibrated model is likely to be better at predicting biological
responses under high and low flow scenarios.</p>
<p>The <code>plot_rngflows</code> function generates a scatterplot for
two flow variables and overlays two convex hulls: one showing the full
range of flow conditions experienced historically, and a second convex
hull showing the range of flow conditions with associated biology
samples. This visualisation helps identify to what extent the available
biology data span the full range of full range of flow conditions
experienced historically.</p>
<p>In the following example, the Q95z and Q10z flow statistics have been
selected as measures of low and high flows within each six month period.
The first plot shows the data for all 20 sites; the second plot is
faceted to show the data separately for each site individually. In this
dataset, biology samples are present for almost every six month period,
and so provide excellent coverage of historical flow conditions.</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">all.combinations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>biol_site_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">biol_data</span><span class="op">$</span><span class="va">biol_site_id</span><span class="op">)</span>, Year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">biol_data</span><span class="op">$</span><span class="va">Year</span><span class="op">)</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">biol_data</span><span class="op">$</span><span class="va">Year</span><span class="op">)</span>, Season <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Spring"</span>, <span class="st">"Autumn"</span><span class="op">)</span>, stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">all.combinations</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 374   3</span></span></code></pre>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">biol_data1</span> <span class="op">&lt;-</span> <span class="va">all.combinations</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">biol_all</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">mapping</span> <span class="op">&lt;-</span> <span class="va">master_data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"biol_site_id"</span>, <span class="st">"flow_site_id"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">join_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/join_he.html">join_he</a></span><span class="op">(</span>biol_data <span class="op">=</span> <span class="va">biol_data1</span>, flow_stats <span class="op">=</span> <span class="va">flowstats_1</span>, mapping <span class="op">=</span> <span class="va">mapping</span>, lags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"A"</span>, join_type <span class="op">=</span> <span class="st">"add_biol"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot_rngflows.html">plot_rngflows</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">join_data</span>, flow_stats <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Q95z_lag0"</span>, <span class="st">"Q10z_lag0"</span><span class="op">)</span>, biol_metric <span class="op">=</span> <span class="st">"LIFE_F_OE"</span>, wrap_by <span class="op">=</span> <span class="cn">NULL</span>, label <span class="op">=</span> <span class="st">"Year"</span><span class="op">)</span></span></code></pre></div>
<p><img src="A.Vignette_files/figure-html/rngflows1-1.png" width="700"></p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_rngflows.html">plot_rngflows</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">join_data</span>, flow_stats <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Q95z_lag0"</span>, <span class="st">"Q10z_lag0"</span><span class="op">)</span>, biol_metric <span class="op">=</span> <span class="st">"LIFE_F_OE"</span>, wrap_by <span class="op">=</span> <span class="st">"biol_site_id"</span>, label <span class="op">=</span> <span class="st">"Year"</span><span class="op">)</span></span></code></pre></div>
<p><img src="A.Vignette_files/figure-html/rngflows1-2.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="hev-plots">HEV plots<a class="anchor" aria-label="anchor" href="#hev-plots"></a>
</h3>
<p>The <code>plot_hev</code> function generates, for one site of
interest, a time series plot of biology sample data and flow summary
statistics, often referred to by the EA as a hydro-ecological validation
(HEV) plot. HEV plots provide a visual assessment of trends in the
historical data, and an initial guide to possible relationships that
could be explored and quantified within a hydro-ecological model.</p>
<p>Whilst the dataset outputted by the <code>join_he</code> function can
be used to produce a HEV plot, a better solution is achieved by via a
combination of manual processing and the <code>add biol</code>
functionality of <code>join_he</code>.</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get output from calc_flowstats</span></span>
<span><span class="va">flowstats_1</span> <span class="op">&lt;-</span> <span class="va">flow_stats</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># create two-column table mapping biology sites to flow sites</span></span>
<span><span class="va">mapping</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">master_data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"biol_site_id"</span>, <span class="st">"flow_site_id"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># filter biology and flow datasets to sites of interest</span></span>
<span><span class="va">biol_data_hev</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">biol_all</span>, <span class="va">biol_site_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">mapping</span><span class="op">$</span><span class="va">biol_site_id</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">flow_data_hev</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">flowstats_1</span>, <span class="va">flow_site_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">mapping</span><span class="op">$</span><span class="va">flow_site_id</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create a complete daily time series for each biology site</span></span>
<span><span class="va">hev_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span></span>
<span>  biol_site_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">biol_data_hev</span><span class="op">$</span><span class="va">biol_site_id</span><span class="op">)</span>, </span>
<span>  date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html" class="external-link">seq.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2011-01-01"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2019-12-31"</span><span class="op">)</span>, by<span class="op">=</span><span class="st">"day"</span><span class="op">)</span>, </span>
<span>  stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create season and water_year columns on which to join the six-monthly flow statistics</span></span>
<span><span class="va">hev_data</span><span class="op">$</span><span class="va">Month</span> <span class="op">&lt;-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html" class="external-link">month</a></span><span class="op">(</span><span class="va">hev_data</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span>
<span><span class="va">hev_data</span><span class="op">$</span><span class="va">Year</span> <span class="op">&lt;-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html" class="external-link">year</a></span><span class="op">(</span><span class="va">hev_data</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># join biology data</span></span>
<span><span class="va">hev_data</span> <span class="op">&lt;-</span> <span class="va">hev_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">biol_data_hev</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"biol_site_id"</span>, <span class="st">"date"</span>, <span class="st">"Year"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># join flow data</span></span>
<span><span class="va">hev_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/join_he.html">join_he</a></span><span class="op">(</span>biol_data <span class="op">=</span> <span class="va">hev_data</span>, flow_stats <span class="op">=</span> <span class="va">flow_data_hev</span>, mapping <span class="op">=</span> <span class="va">mapping</span>, method <span class="op">=</span> <span class="st">"B"</span>, join_type <span class="op">=</span> <span class="st">"add_biol"</span><span class="op">)</span></span></code></pre></div>
<p>Using this new <code>hev_data</code> dataset, the following example
uses <code>multiplot = TRUE</code> to produce HEV plots for four
macroinvertebrate metrics at one site.</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_hev.html">plot_hev</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">hev_data</span>, <span class="va">biol_site_id</span> <span class="op">==</span> <span class="st">"34352"</span><span class="op">)</span>, </span>
<span>         date_col <span class="op">=</span> <span class="st">"date"</span>, </span>
<span>         flow_stat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Q95z_lag0"</span>, <span class="st">"Q10z_lag0"</span><span class="op">)</span>, </span>
<span>         biol_metric <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"LIFE_F_OE"</span>, <span class="st">"WHPT_ASPT_OE"</span>, <span class="st">"WHPT_NTAXA_OE"</span>, <span class="st">"PSI_OE"</span><span class="op">)</span>, </span>
<span>         multiplot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="A.Vignette_files/figure-html/hevplot1-1.png" width="700"></p>
<p>The <code>save</code> argument can be used to export the HEV plot as
a .png file. The name of the png file is fixed, however, so to generate
a separate png file for each site requires a loop.</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bsi</span> <span class="op">&lt;-</span> <span class="va">mapping</span><span class="op">$</span><span class="va">biol_site_id</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="co">#for(i in mapping$biol_site_id){</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="va">bsi</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">hev_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_hev.html">plot_hev</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">hev_data</span>, <span class="va">biol_site_id</span> <span class="op">==</span> <span class="va">i</span><span class="op">)</span>, </span>
<span>         date_col <span class="op">=</span> <span class="st">"date"</span>, </span>
<span>         flow_stat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Q95z_lag0"</span>, <span class="st">"Q10z_lag0"</span><span class="op">)</span>, </span>
<span>         biol_metric <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"LIFE_F_OE"</span><span class="op">)</span>, </span>
<span>         clr_by <span class="op">=</span> <span class="st">"biol_site_id"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="va">hev_plot</span>, device <span class="op">=</span> <span class="st">"png"</span>, path <span class="op">=</span> <span class="st">"Plots/"</span>, filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">i</span>,<span class="st">"_hevplot.png"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="A.Vignette_files/figure-html/hevplot2-1.png" width="700"><img src="A.Vignette_files/figure-html/hevplot2-2.png" width="700"><img src="A.Vignette_files/figure-html/hevplot2-3.png" width="700"><img src="A.Vignette_files/figure-html/hevplot2-4.png" width="700"><img src="A.Vignette_files/figure-html/hevplot2-5.png" width="700"></p>
<p>The example above shows the standard HEV plot, using non-overlapping
6-month (winter and summer) windows. By changing the inputs to the
calc_flowstats function, HEV plots with different window widths can be
also be plotted. The example below shows the same data but displayed
with 12-month windows. The call to calc_flowstats used for this is:</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># calculate flow statistics</span></span>
<span><span class="va">flow_stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_flowstats.html">calc_flowstats</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">flow_data</span>,</span>
<span>                           site_col <span class="op">=</span> <span class="st">"flow_site_id"</span>,</span>
<span>                           date_col <span class="op">=</span> <span class="st">"date"</span>,</span>
<span>                           flow_col <span class="op">=</span> <span class="st">"flow"</span>,</span>
<span>                           win_width <span class="op">=</span> <span class="st">"6 months"</span>,</span>
<span>                           win_step <span class="op">=</span> <span class="st">"6 months"</span><span class="op">)</span></span></code></pre></div>
<p><img src="A.Vignette_files/figure-html/unnamed-chunk-1-1.png" width="700"></p>
<p>To interactively examine time series relationships for different
metrics and sites, use the <code>shiny_hev</code> function, which
launches a HEV plot within a shiny app.</p>
</div>
</div>
<div class="section level2">
<h2 id="model-calibration">Model calibration<a class="anchor" aria-label="anchor" href="#model-calibration"></a>
</h2>
<div class="section level3">
<h3 id="model-selection">Model selection<a class="anchor" aria-label="anchor" href="#model-selection"></a>
</h3>
<p>Once the biology and flow data has been assembled and explored,
spatial and temporal variation in a biological metric of interest can be
modelled as a function of one or more flow summary statistics to reveal
potential hydro-ecological relationships. For datasets comprising
multiple sites, linear mixed-effects models have the ability to describe
a ‘global’ relationship that applies across all sites, whilst also
quantifying the degree of variability in this relationship from site to
site.</p>
<p>The following example illustrates a mixed-effects model fitted to
autumn macroinvertebrate data using the <code>lmer</code> function from
the <code>lme4</code> package. The model includes three variables
representing high and low flows in different antecedent periods (Q95z,
Q10z), and Q95z also has a random (site-specific) slope.</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># filter data by season</span></span>
<span><span class="va">autumn_data</span> <span class="op">&lt;-</span> <span class="va">all_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Season</span> <span class="op">==</span> <span class="st">"Autumn"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#filter data to eliminate NAs (necessary for cross-validation later on)</span></span>
<span><span class="va">autumn_data</span> <span class="op">&lt;-</span> <span class="va">autumn_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">LIFE_F_OE</span><span class="op">)</span> <span class="op">==</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">autumn_data</span> <span class="op">&lt;-</span> <span class="va">autumn_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">biol_site_id</span><span class="op">)</span> <span class="op">==</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">autumn_data</span> <span class="op">&lt;-</span> <span class="va">autumn_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Q95z_lag0</span><span class="op">)</span> <span class="op">==</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">autumn_data</span> <span class="op">&lt;-</span> <span class="va">autumn_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Q10z_lag0</span><span class="op">)</span> <span class="op">==</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">autumn_data</span> <span class="op">&lt;-</span> <span class="va">autumn_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Q95z_lag1</span><span class="op">)</span> <span class="op">==</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_full</span> <span class="op">&lt;-</span> <span class="fu">lme4</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer</a></span><span class="op">(</span><span class="va">LIFE_F_OE</span> <span class="op">~</span> <span class="va">Q95z_lag0</span> <span class="op">+</span> <span class="va">Q10z_lag0</span> <span class="op">+</span> <span class="va">Q95z_lag1</span> <span class="op">+</span> <span class="op">(</span><span class="va">Q95z_lag0</span> <span class="op">|</span> <span class="va">biol_site_id</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">autumn_data</span>, REML <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">model_full</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Linear mixed model fit by maximum likelihood  ['lmerMod']</span></span>
<span><span class="co">## Formula: LIFE_F_OE ~ Q95z_lag0 + Q10z_lag0 + Q95z_lag1 + (Q95z_lag0 |  </span></span>
<span><span class="co">##     biol_site_id)</span></span>
<span><span class="co">##    Data: autumn_data</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##      AIC      BIC   logLik deviance df.resid </span></span>
<span><span class="co">##   -538.9   -514.1    277.5   -554.9      156 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Scaled residuals: </span></span>
<span><span class="co">##      Min       1Q   Median       3Q      Max </span></span>
<span><span class="co">## -3.15766 -0.56189 -0.01551  0.54874  2.78413 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Random effects:</span></span>
<span><span class="co">##  Groups       Name        Variance  Std.Dev. Corr </span></span>
<span><span class="co">##  biol_site_id (Intercept) 4.560e-03 0.067529      </span></span>
<span><span class="co">##               Q95z_lag0   2.245e-05 0.004738 -1.00</span></span>
<span><span class="co">##  Residual                 1.380e-03 0.037154      </span></span>
<span><span class="co">## Number of obs: 164, groups:  biol_site_id, 17</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Fixed effects:</span></span>
<span><span class="co">##               Estimate Std. Error t value</span></span>
<span><span class="co">## (Intercept)  1.025e+00  1.666e-02  61.542</span></span>
<span><span class="co">## Q95z_lag0   -1.306e-03  5.761e-03  -0.227</span></span>
<span><span class="co">## Q10z_lag0    4.982e-03  4.595e-03   1.084</span></span>
<span><span class="co">## Q95z_lag1   -1.276e-06  2.701e-03   0.000</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Correlation of Fixed Effects:</span></span>
<span><span class="co">##           (Intr) Q95z_0 Q10z_0</span></span>
<span><span class="co">## Q95z_lag0 -0.146              </span></span>
<span><span class="co">## Q10z_lag0 -0.036 -0.701       </span></span>
<span><span class="co">## Q95z_lag1 -0.022 -0.095  0.221</span></span>
<span><span class="co">## optimizer (nloptwrap) convergence code: 0 (OK)</span></span>
<span><span class="co">## boundary (singular) fit: see help('isSingular')</span></span></code></pre>
<p>To aid model selection, the <code>hetoolkit</code> package includes
two functions for performing cross-validation.</p>
<p><code>model_cv</code> performs repeated, stratified k-fold
cross-validation, which can be used to evaluate a model’s ability to
predict the response at sites in the calibration dataset. Alternatively,
<code>model_logocv</code> performs leave-one-group-out cross-validation,
which can be used to evaluate a model’s ability to predict the response
at sites not in the calibration dataset. Both functions can be applied
to linear mixed-effects model (class: lmerMod) or hierarchical
generalized additive model (class: gam) model with a single random
grouping factor. See <code><a href="../reference/model_cv.html">?model_cv</a></code> and
<code><a href="../reference/model_logocv.html">?model_logocv</a></code> for details.</p>
<p><code>model_cv</code> and <code>model_logocv</code> measure the
performance of the model under different situations, and so will not
necessarily agree which is the best model. If the priority is to be able
to predict the response at sites in the calibration dataset, then use
<code>model_cv</code>; if the priority is to be able to predict the
response at sites not in the calibration dataset, then use
<code>model_logocv</code>.</p>
<p>In the following example, the process of simplifying the full model
is guided by <code>model_cv</code>, which measures predictive
performance using the Root Mean Square Error (RMSE); lower values
indicate better predictions. <code>r</code> is set at 20 to give stable
RMSE estimates and <code>control</code> is used to help prevent model
convergence issues. Backward elimination of random-effect terms is
followed by backward elimination of fixed-effect terms, until the RMSE
cannot be reduced any further. <code>model_3</code> is the final,
preferred model.</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get RMSE estimate</span></span>
<span><span class="va">cv_full</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## $RMSE</span></span>
<span><span class="co">## [1] 0.04097054</span></span></code></pre>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># drop random slope</span></span>
<span><span class="va">model_1</span> <span class="op">&lt;-</span> <span class="va">model_full</span> <span class="op">&lt;-</span> <span class="fu">lme4</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer</a></span><span class="op">(</span><span class="va">LIFE_F_OE</span> <span class="op">~</span> <span class="va">Q95z_lag0</span> <span class="op">+</span> <span class="va">Q10z_lag0</span> <span class="op">+</span> <span class="va">Q95z_lag1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">biol_site_id</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">autumn_data</span>, REML <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cv_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_cv.html">model_cv</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">model_1</span>, data <span class="op">=</span> <span class="va">autumn_data</span>, group <span class="op">=</span> <span class="st">"biol_site_id"</span>, k <span class="op">=</span> <span class="fl">5</span>, r <span class="op">=</span> <span class="fl">20</span>, control <span class="op">=</span> <span class="va">my_control</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># model_1 has a lower RMSE than model_full, so drop Q95z slope</span></span>
<span><span class="va">cv_1</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## $RMSE</span></span>
<span><span class="co">## [1] 0.04023993</span></span></code></pre>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># drop Q95zLS1 term</span></span>
<span><span class="va">model_2</span> <span class="op">&lt;-</span> <span class="va">model_full</span> <span class="op">&lt;-</span> <span class="fu">lme4</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer</a></span><span class="op">(</span><span class="va">LIFE_F_OE</span> <span class="op">~</span> <span class="va">Q95z_lag0</span> <span class="op">+</span> <span class="va">Q10z_lag0</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">biol_site_id</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">autumn_data</span>, REML <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cv_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_cv.html">model_cv</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">model_2</span>, data <span class="op">=</span> <span class="va">autumn_data</span>, group <span class="op">=</span> <span class="st">"biol_site_id"</span>, k <span class="op">=</span> <span class="fl">5</span>, r <span class="op">=</span> <span class="fl">20</span>, control <span class="op">=</span> <span class="va">my_control</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># model_2 has a lower RMSE than model_full, so drop Q95zLS1</span></span>
<span><span class="va">cv_2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## $RMSE</span></span>
<span><span class="co">## [1] 0.03964198</span></span></code></pre>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># drop Q10z term</span></span>
<span><span class="va">model_3</span> <span class="op">&lt;-</span> <span class="va">model_full</span> <span class="op">&lt;-</span> <span class="fu">lme4</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer</a></span><span class="op">(</span><span class="va">LIFE_F_OE</span> <span class="op">~</span> <span class="va">Q95z_lag0</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">biol_site_id</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">autumn_data</span>, REML <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cv_3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_cv.html">model_cv</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">model_3</span>, data <span class="op">=</span> <span class="va">autumn_data</span>, group <span class="op">=</span> <span class="st">"biol_site_id"</span>, k <span class="op">=</span> <span class="fl">5</span>, r <span class="op">=</span> <span class="fl">20</span>, control <span class="op">=</span> <span class="va">my_control</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># model_3 has a lower RMSE than model_2, so drop Q10z</span></span>
<span><span class="va">cv_3</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## $RMSE</span></span>
<span><span class="co">## [1] 0.03951175</span></span></code></pre>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># no further model simplification possible; model_3 is the final model.</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="model-diagnostics">Model diagnostics<a class="anchor" aria-label="anchor" href="#model-diagnostics"></a>
</h3>
<p>The <code>diag_lmer</code> function produces a variety of diagnostic
plots for a mixed-effects regression (lmer) model.</p>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># generate diagnostic plots</span></span>
<span><span class="va">diag_plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/diag_lmer.html">diag_lmer</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">model_3</span>, data <span class="op">=</span> <span class="va">autumn_data</span>, facet_by <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<p>These include:</p>
<ol style="list-style-type: decimal">
<li>Fitted vs observed values.</li>
</ol>
<p><img src="A.Vignette_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<ol start="2" style="list-style-type: decimal">
<li>Normal probability plot.</li>
</ol>
<p><img src="A.Vignette_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<ol start="3" style="list-style-type: decimal">
<li>Residuals vs fitted.</li>
</ol>
<p><img src="A.Vignette_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<ol start="4" style="list-style-type: decimal">
<li>Histogram of residuals.</li>
</ol>
<p><img src="A.Vignette_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<ol start="5" style="list-style-type: decimal">
<li>Residuals vs model fixed predictors. This displays a linear model
(red) for each fixed predictor vs the model’s residuals. The blue line
is a loess-smoothed line. The main purpose of this plot is to check
whether or not the relationship between residuals and a predictor is
linear.</li>
</ol>
<p><img src="A.Vignette_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
<p>Alternatively, the plots can be faceted by site, to explore model fit
and residuals site-by-site. In this example, the sites are arranged in
descending order by the mean of the fitted values.</p>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># generate diagnostic plots</span></span>
<span><span class="va">diag_plots2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/diag_lmer.html">diag_lmer</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">model_3</span>, </span>
<span>                         data <span class="op">=</span> <span class="va">autumn_data</span>, </span>
<span>                         facet_by <span class="op">=</span> <span class="st">"biol_site_id"</span>, </span>
<span>                         order_by <span class="op">=</span> <span class="st">"mean"</span>, </span>
<span>                         order <span class="op">=</span> <span class="st">"descending"</span>, </span>
<span>                         ncol <span class="op">=</span> <span class="fl">4</span>, </span>
<span>                         scales <span class="op">=</span> <span class="st">"fixed"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">diag_plots2</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="A.Vignette_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">diag_plots2</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="A.Vignette_files/figure-html/unnamed-chunk-13-2.png" width="700"></p>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">diag_plots2</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="A.Vignette_files/figure-html/unnamed-chunk-13-3.png" width="700"></p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># boxplot instead of histogram of residuals:</span></span>
<span><span class="va">diag_plots2</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="A.Vignette_files/figure-html/unnamed-chunk-13-4.png" width="700"></p>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># same as un-faceted option:</span></span>
<span><span class="co"># diag_plots2[[5]]</span></span></code></pre></div>
<p>Other useful diagnostic plots for <code>lmer</code> models
include:</p>
<ul>
<li>caterpillar plots, for visualising the random intercepts (and, where
included, slopes) for each site:</li>
</ul>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">sjPlot</span><span class="fu">::</span><span class="fu"><a href="https://strengejacke.github.io/sjPlot/reference/plot_model.html" class="external-link">plot_model</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">model_3</span>, </span>
<span>                   type <span class="op">=</span> <span class="st">"re"</span>, </span>
<span>                   facet.grid <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>                   free.scale <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>                   title <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                   vline.color <span class="op">=</span> <span class="st">"darkgrey"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.2</span>,<span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
<p><img src="A.Vignette_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<ul>
<li>partial regression plot for a fixed effect, showing the ‘global’
relationship:</li>
</ul>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">visreg</span><span class="fu">::</span><span class="fu"><a href="http://pbreheny.github.io/visreg/reference/visreg.html" class="external-link">visreg</a></span><span class="op">(</span><span class="va">model_3</span>, <span class="st">"Q95z_lag0"</span>, ylab <span class="op">=</span> <span class="st">"LIFE_F_OE"</span><span class="op">)</span></span></code></pre></div>
<p><img src="A.Vignette_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
<ul>
<li>partial regression plot for a random effect, showing the
site-specific relationship (here only random intercepts were included so
the slope is consistent among sites):</li>
</ul>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">visreg</span><span class="fu">::</span><span class="fu"><a href="http://pbreheny.github.io/visreg/reference/visreg.html" class="external-link">visreg</a></span><span class="op">(</span><span class="va">model_3</span>, <span class="st">"Q95z_lag0"</span>, by <span class="op">=</span> <span class="st">"biol_site_id"</span>, ylab <span class="op">=</span> <span class="st">"LIFE_F_OE"</span><span class="op">)</span></span></code></pre></div>
<p><img src="A.Vignette_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="predictions">Predictions<a class="anchor" aria-label="anchor" href="#predictions"></a>
</h3>
<p>The <code>plot_predictions</code> function produces a time series
plot of predictions from a hydro-ecological model, alongside observed
biology and flow data. The plot is faceted by site, as specified by the
<code>site_col</code> argument. The function generates a ggplot object,
which can optionally be saved as a .png file named
“Predictions_Plot.png”.</p>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate prediction intervals</span></span>
<span><span class="va">pi</span> <span class="op">&lt;-</span> <span class="fu">merTools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/merTools/man/predictInterval.html" class="external-link">predictInterval</a></span><span class="op">(</span>merMod <span class="op">=</span> <span class="va">model_3</span>, </span>
<span>                                level <span class="op">=</span> <span class="fl">0.95</span>, </span>
<span>                                n.sims <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                                stat <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>                                type<span class="op">=</span><span class="st">"linear.prediction"</span>,</span>
<span>                                include.resid.var <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># bind to model calibration dataset</span></span>
<span><span class="va">autumn_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">autumn_data</span>, <span class="va">pi</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># produce predictions plot</span></span>
<span><span class="fu"><a href="../reference/plot_predictions.html">plot_predictions</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">autumn_data</span>,</span>
<span>                  biol_metric <span class="op">=</span> <span class="st">"LIFE_F_OE"</span>,</span>
<span>                  time_col <span class="op">=</span> <span class="st">"Year"</span>,</span>
<span>                  site_col <span class="op">=</span> <span class="st">"biol_site_id"</span>,</span>
<span>                  flow_stat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Q95z_lag0"</span>, <span class="st">"Q10z_lag0"</span><span class="op">)</span>,</span>
<span>                  pred_col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fit"</span>, <span class="st">"lwr"</span>, <span class="st">"upr"</span><span class="op">)</span>,</span>
<span>                  ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<p><img src="A.Vignette_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Environment Agency, APEM Ltd.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
